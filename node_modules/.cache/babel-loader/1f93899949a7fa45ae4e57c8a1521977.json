{"ast":null,"code":"import unionWith from 'lodash/unionWith';\nimport config from '../../config';\nimport { storableError } from '../../util/errors';\nimport { convertUnitToSubUnit, unitDivisor } from '../../util/currency';\nimport { parseDateFromISO8601, getExclusiveEndDate } from '../../util/dates';\nimport { createImageVariantConfig } from '../../util/sdkLoader';\nimport { isOriginInUse, isStockInUse } from '../../util/search';\nimport { parse } from '../../util/urlHelpers';\nimport { addMarketplaceEntities } from '../../ducks/marketplaceData.duck'; // Pagination page size might need to be dynamic on responsive page layouts\n// Current design has max 3 columns 12 is divisible by 2 and 3\n// So, there's enough cards to fill all columns on full pagination pages\n\nconst RESULT_PAGE_SIZE = 24; // ================ Action types ================ //\n\nexport const SEARCH_LISTINGS_REQUEST = 'app/SearchPage/SEARCH_LISTINGS_REQUEST';\nexport const SEARCH_LISTINGS_SUCCESS = 'app/SearchPage/SEARCH_LISTINGS_SUCCESS';\nexport const SEARCH_LISTINGS_ERROR = 'app/SearchPage/SEARCH_LISTINGS_ERROR';\nexport const SEARCH_MAP_LISTINGS_REQUEST = 'app/SearchPage/SEARCH_MAP_LISTINGS_REQUEST';\nexport const SEARCH_MAP_LISTINGS_SUCCESS = 'app/SearchPage/SEARCH_MAP_LISTINGS_SUCCESS';\nexport const SEARCH_MAP_LISTINGS_ERROR = 'app/SearchPage/SEARCH_MAP_LISTINGS_ERROR';\nexport const SEARCH_MAP_SET_ACTIVE_LISTING = 'app/SearchPage/SEARCH_MAP_SET_ACTIVE_LISTING'; // ================ Reducer ================ //\n\nconst initialState = {\n  pagination: null,\n  searchParams: null,\n  searchInProgress: false,\n  searchListingsError: null,\n  currentPageResultIds: [],\n  searchMapListingIds: [],\n  searchMapListingsError: null\n};\n\nconst resultIds = data => data.data.map(l => l.id);\n\nconst listingPageReducer = (state = initialState, action = {}) => {\n  const {\n    type,\n    payload\n  } = action;\n\n  switch (type) {\n    case SEARCH_LISTINGS_REQUEST:\n      return { ...state,\n        searchParams: payload.searchParams,\n        searchInProgress: true,\n        searchMapListingIds: [],\n        searchListingsError: null\n      };\n\n    case SEARCH_LISTINGS_SUCCESS:\n      return { ...state,\n        currentPageResultIds: resultIds(payload.data),\n        pagination: payload.data.meta,\n        searchInProgress: false\n      };\n\n    case SEARCH_LISTINGS_ERROR:\n      // eslint-disable-next-line no-console\n      console.error(payload);\n      return { ...state,\n        searchInProgress: false,\n        searchListingsError: payload\n      };\n\n    case SEARCH_MAP_LISTINGS_REQUEST:\n      return { ...state,\n        searchMapListingsError: null\n      };\n\n    case SEARCH_MAP_LISTINGS_SUCCESS:\n      {\n        const searchMapListingIds = unionWith(state.searchMapListingIds, resultIds(payload.data), (id1, id2) => id1.uuid === id2.uuid);\n        return { ...state,\n          searchMapListingIds\n        };\n      }\n\n    case SEARCH_MAP_LISTINGS_ERROR:\n      // eslint-disable-next-line no-console\n      console.error(payload);\n      return { ...state,\n        searchMapListingsError: payload\n      };\n\n    case SEARCH_MAP_SET_ACTIVE_LISTING:\n      return { ...state,\n        activeListingId: payload\n      };\n\n    default:\n      return state;\n  }\n};\n\nexport default listingPageReducer; // ================ Action creators ================ //\n\nexport const searchListingsRequest = searchParams => ({\n  type: SEARCH_LISTINGS_REQUEST,\n  payload: {\n    searchParams\n  }\n});\nexport const searchListingsSuccess = response => ({\n  type: SEARCH_LISTINGS_SUCCESS,\n  payload: {\n    data: response.data\n  }\n});\nexport const searchListingsError = e => ({\n  type: SEARCH_LISTINGS_ERROR,\n  error: true,\n  payload: e\n});\nexport const searchMapListingsRequest = () => ({\n  type: SEARCH_MAP_LISTINGS_REQUEST\n});\nexport const searchMapListingsSuccess = response => ({\n  type: SEARCH_MAP_LISTINGS_SUCCESS,\n  payload: {\n    data: response.data\n  }\n});\nexport const searchMapListingsError = e => ({\n  type: SEARCH_MAP_LISTINGS_ERROR,\n  error: true,\n  payload: e\n});\nexport const searchListings = searchParams => (dispatch, getState, sdk) => {\n  dispatch(searchListingsRequest(searchParams));\n\n  const priceSearchParams = priceParam => {\n    const inSubunits = value => convertUnitToSubUnit(value, unitDivisor(config.currencyConfig.currency));\n\n    const values = priceParam ? priceParam.split(',') : [];\n    return priceParam && values.length === 2 ? {\n      price: [inSubunits(values[0]), inSubunits(values[1]) + 1].join(',')\n    } : {};\n  };\n\n  const datesSearchParams = datesParam => {\n    const values = datesParam ? datesParam.split(',') : [];\n    const hasValues = datesParam && values.length === 2;\n    const startDate = hasValues ? values[0] : null;\n    const isNightlyBooking = config.lineItemUnitType === 'line-item/night';\n    const endDate = hasValues && isNightlyBooking ? values[1] : hasValues ? getExclusiveEndDate(values[1], 'Etc/UTC') : null;\n    return hasValues ? {\n      start: parseDateFromISO8601(startDate, 'Etc/UTC'),\n      end: parseDateFromISO8601(endDate, 'Etc/UTC'),\n      // Availability can be full or partial. Default value is full.\n      availability: 'full'\n    } : {};\n  };\n\n  const {\n    perPage,\n    price,\n    dates,\n    sort,\n    ...rest\n  } = searchParams;\n  const priceMaybe = priceSearchParams(price);\n  const datesMaybe = datesSearchParams(dates);\n  const sortMaybe = sort === config.custom.sortConfig.relevanceKey ? {} : {\n    sort\n  };\n  const params = { ...rest,\n    ...priceMaybe,\n    ...datesMaybe,\n    ...sortMaybe,\n    per_page: perPage\n  };\n  return sdk.listings.query(params).then(response => {\n    dispatch(addMarketplaceEntities(response));\n    dispatch(searchListingsSuccess(response));\n    return response;\n  }).catch(e => {\n    dispatch(searchListingsError(storableError(e)));\n    throw e;\n  });\n};\nexport const setActiveListing = listingId => ({\n  type: SEARCH_MAP_SET_ACTIVE_LISTING,\n  payload: listingId\n});\nexport const searchMapListings = searchParams => (dispatch, getState, sdk) => {\n  dispatch(searchMapListingsRequest(searchParams));\n  const {\n    perPage,\n    ...rest\n  } = searchParams;\n  const params = { ...rest,\n    per_page: perPage\n  };\n  return sdk.listings.query(params).then(response => {\n    dispatch(addMarketplaceEntities(response));\n    dispatch(searchMapListingsSuccess(response));\n    return response;\n  }).catch(e => {\n    dispatch(searchMapListingsError(storableError(e)));\n    throw e;\n  });\n};\nexport const loadData = (params, search) => {\n  const queryParams = parse(search, {\n    latlng: ['origin'],\n    latlngBounds: ['bounds']\n  }); // Add minStock filter with default value (1), if stock management is in use.\n  // This can be overwriten with passed-in query parameters.\n\n  const minStockMaybe = isStockInUse(config) ? {\n    minStock: 1\n  } : {};\n  const {\n    page = 1,\n    address,\n    origin,\n    ...rest\n  } = queryParams;\n  const originMaybe = isOriginInUse(config) && origin ? {\n    origin\n  } : {};\n  const {\n    aspectWidth = 1,\n    aspectHeight = 1,\n    variantPrefix = 'listing-card'\n  } = config.listing;\n  const aspectRatio = aspectHeight / aspectWidth;\n  return searchListings({ ...minStockMaybe,\n    ...rest,\n    ...originMaybe,\n    page,\n    perPage: RESULT_PAGE_SIZE,\n    include: ['author', 'images'],\n    'fields.listing': ['title', 'geolocation', 'price'],\n    'fields.user': ['profile.displayName', 'profile.abbreviatedName'],\n    'fields.image': [`variants.${variantPrefix}`, `variants.${variantPrefix}-2x`],\n    ...createImageVariantConfig(`${variantPrefix}`, 400, aspectRatio),\n    ...createImageVariantConfig(`${variantPrefix}-2x`, 800, aspectRatio),\n    'limit.images': 1\n  });\n};","map":{"version":3,"sources":["D:/Amardeep/tarek_project/ftw-product/src/containers/SearchPage/SearchPage.duck.js"],"names":["unionWith","config","storableError","convertUnitToSubUnit","unitDivisor","parseDateFromISO8601","getExclusiveEndDate","createImageVariantConfig","isOriginInUse","isStockInUse","parse","addMarketplaceEntities","RESULT_PAGE_SIZE","SEARCH_LISTINGS_REQUEST","SEARCH_LISTINGS_SUCCESS","SEARCH_LISTINGS_ERROR","SEARCH_MAP_LISTINGS_REQUEST","SEARCH_MAP_LISTINGS_SUCCESS","SEARCH_MAP_LISTINGS_ERROR","SEARCH_MAP_SET_ACTIVE_LISTING","initialState","pagination","searchParams","searchInProgress","searchListingsError","currentPageResultIds","searchMapListingIds","searchMapListingsError","resultIds","data","map","l","id","listingPageReducer","state","action","type","payload","meta","console","error","id1","id2","uuid","activeListingId","searchListingsRequest","searchListingsSuccess","response","e","searchMapListingsRequest","searchMapListingsSuccess","searchListings","dispatch","getState","sdk","priceSearchParams","priceParam","inSubunits","value","currencyConfig","currency","values","split","length","price","join","datesSearchParams","datesParam","hasValues","startDate","isNightlyBooking","lineItemUnitType","endDate","start","end","availability","perPage","dates","sort","rest","priceMaybe","datesMaybe","sortMaybe","custom","sortConfig","relevanceKey","params","per_page","listings","query","then","catch","setActiveListing","listingId","searchMapListings","loadData","search","queryParams","latlng","latlngBounds","minStockMaybe","minStock","page","address","origin","originMaybe","aspectWidth","aspectHeight","variantPrefix","listing","aspectRatio","include"],"mappings":"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","sourcesContent":["import unionWith from 'lodash/unionWith';\r\n\r\nimport config from '../../config';\r\nimport { storableError } from '../../util/errors';\r\nimport { convertUnitToSubUnit, unitDivisor } from '../../util/currency';\r\nimport { parseDateFromISO8601, getExclusiveEndDate } from '../../util/dates';\r\nimport { createImageVariantConfig } from '../../util/sdkLoader';\r\nimport { isOriginInUse, isStockInUse } from '../../util/search';\r\nimport { parse } from '../../util/urlHelpers';\r\nimport { addMarketplaceEntities } from '../../ducks/marketplaceData.duck';\r\n\r\n// Pagination page size might need to be dynamic on responsive page layouts\r\n// Current design has max 3 columns 12 is divisible by 2 and 3\r\n// So, there's enough cards to fill all columns on full pagination pages\r\nconst RESULT_PAGE_SIZE = 24;\r\n\r\n// ================ Action types ================ //\r\n\r\nexport const SEARCH_LISTINGS_REQUEST = 'app/SearchPage/SEARCH_LISTINGS_REQUEST';\r\nexport const SEARCH_LISTINGS_SUCCESS = 'app/SearchPage/SEARCH_LISTINGS_SUCCESS';\r\nexport const SEARCH_LISTINGS_ERROR = 'app/SearchPage/SEARCH_LISTINGS_ERROR';\r\n\r\nexport const SEARCH_MAP_LISTINGS_REQUEST = 'app/SearchPage/SEARCH_MAP_LISTINGS_REQUEST';\r\nexport const SEARCH_MAP_LISTINGS_SUCCESS = 'app/SearchPage/SEARCH_MAP_LISTINGS_SUCCESS';\r\nexport const SEARCH_MAP_LISTINGS_ERROR = 'app/SearchPage/SEARCH_MAP_LISTINGS_ERROR';\r\n\r\nexport const SEARCH_MAP_SET_ACTIVE_LISTING = 'app/SearchPage/SEARCH_MAP_SET_ACTIVE_LISTING';\r\n\r\n// ================ Reducer ================ //\r\n\r\nconst initialState = {\r\n  pagination: null,\r\n  searchParams: null,\r\n  searchInProgress: false,\r\n  searchListingsError: null,\r\n  currentPageResultIds: [],\r\n  searchMapListingIds: [],\r\n  searchMapListingsError: null,\r\n};\r\n\r\nconst resultIds = data => data.data.map(l => l.id);\r\n\r\nconst listingPageReducer = (state = initialState, action = {}) => {\r\n  const { type, payload } = action;\r\n  switch (type) {\r\n    case SEARCH_LISTINGS_REQUEST:\r\n      return {\r\n        ...state,\r\n        searchParams: payload.searchParams,\r\n        searchInProgress: true,\r\n        searchMapListingIds: [],\r\n        searchListingsError: null,\r\n      };\r\n    case SEARCH_LISTINGS_SUCCESS:\r\n      return {\r\n        ...state,\r\n        currentPageResultIds: resultIds(payload.data),\r\n        pagination: payload.data.meta,\r\n        searchInProgress: false,\r\n      };\r\n    case SEARCH_LISTINGS_ERROR:\r\n      // eslint-disable-next-line no-console\r\n      console.error(payload);\r\n      return { ...state, searchInProgress: false, searchListingsError: payload };\r\n\r\n    case SEARCH_MAP_LISTINGS_REQUEST:\r\n      return {\r\n        ...state,\r\n        searchMapListingsError: null,\r\n      };\r\n    case SEARCH_MAP_LISTINGS_SUCCESS: {\r\n      const searchMapListingIds = unionWith(\r\n        state.searchMapListingIds,\r\n        resultIds(payload.data),\r\n        (id1, id2) => id1.uuid === id2.uuid\r\n      );\r\n      return {\r\n        ...state,\r\n        searchMapListingIds,\r\n      };\r\n    }\r\n    case SEARCH_MAP_LISTINGS_ERROR:\r\n      // eslint-disable-next-line no-console\r\n      console.error(payload);\r\n      return { ...state, searchMapListingsError: payload };\r\n\r\n    case SEARCH_MAP_SET_ACTIVE_LISTING:\r\n      return {\r\n        ...state,\r\n        activeListingId: payload,\r\n      };\r\n    default:\r\n      return state;\r\n  }\r\n};\r\n\r\nexport default listingPageReducer;\r\n\r\n// ================ Action creators ================ //\r\n\r\nexport const searchListingsRequest = searchParams => ({\r\n  type: SEARCH_LISTINGS_REQUEST,\r\n  payload: { searchParams },\r\n});\r\n\r\nexport const searchListingsSuccess = response => ({\r\n  type: SEARCH_LISTINGS_SUCCESS,\r\n  payload: { data: response.data },\r\n});\r\n\r\nexport const searchListingsError = e => ({\r\n  type: SEARCH_LISTINGS_ERROR,\r\n  error: true,\r\n  payload: e,\r\n});\r\n\r\nexport const searchMapListingsRequest = () => ({ type: SEARCH_MAP_LISTINGS_REQUEST });\r\n\r\nexport const searchMapListingsSuccess = response => ({\r\n  type: SEARCH_MAP_LISTINGS_SUCCESS,\r\n  payload: { data: response.data },\r\n});\r\n\r\nexport const searchMapListingsError = e => ({\r\n  type: SEARCH_MAP_LISTINGS_ERROR,\r\n  error: true,\r\n  payload: e,\r\n});\r\n\r\nexport const searchListings = searchParams => (dispatch, getState, sdk) => {\r\n  dispatch(searchListingsRequest(searchParams));\r\n\r\n  const priceSearchParams = priceParam => {\r\n    const inSubunits = value =>\r\n      convertUnitToSubUnit(value, unitDivisor(config.currencyConfig.currency));\r\n    const values = priceParam ? priceParam.split(',') : [];\r\n    return priceParam && values.length === 2\r\n      ? {\r\n          price: [inSubunits(values[0]), inSubunits(values[1]) + 1].join(','),\r\n        }\r\n      : {};\r\n  };\r\n\r\n  const datesSearchParams = datesParam => {\r\n    const values = datesParam ? datesParam.split(',') : [];\r\n    const hasValues = datesParam && values.length === 2;\r\n    const startDate = hasValues ? values[0] : null;\r\n    const isNightlyBooking = config.lineItemUnitType === 'line-item/night';\r\n    const endDate =\r\n      hasValues && isNightlyBooking\r\n        ? values[1]\r\n        : hasValues\r\n        ? getExclusiveEndDate(values[1], 'Etc/UTC')\r\n        : null;\r\n\r\n    return hasValues\r\n      ? {\r\n          start: parseDateFromISO8601(startDate, 'Etc/UTC'),\r\n          end: parseDateFromISO8601(endDate, 'Etc/UTC'),\r\n          // Availability can be full or partial. Default value is full.\r\n          availability: 'full',\r\n        }\r\n      : {};\r\n  };\r\n\r\n  const { perPage, price, dates, sort, ...rest } = searchParams;\r\n  const priceMaybe = priceSearchParams(price);\r\n  const datesMaybe = datesSearchParams(dates);\r\n  const sortMaybe = sort === config.custom.sortConfig.relevanceKey ? {} : { sort };\r\n\r\n  const params = {\r\n    ...rest,\r\n    ...priceMaybe,\r\n    ...datesMaybe,\r\n    ...sortMaybe,\r\n    per_page: perPage,\r\n  };\r\n\r\n  return sdk.listings\r\n    .query(params)\r\n    .then(response => {\r\n      dispatch(addMarketplaceEntities(response));\r\n      dispatch(searchListingsSuccess(response));\r\n      return response;\r\n    })\r\n    .catch(e => {\r\n      dispatch(searchListingsError(storableError(e)));\r\n      throw e;\r\n    });\r\n};\r\n\r\nexport const setActiveListing = listingId => ({\r\n  type: SEARCH_MAP_SET_ACTIVE_LISTING,\r\n  payload: listingId,\r\n});\r\n\r\nexport const searchMapListings = searchParams => (dispatch, getState, sdk) => {\r\n  dispatch(searchMapListingsRequest(searchParams));\r\n\r\n  const { perPage, ...rest } = searchParams;\r\n  const params = {\r\n    ...rest,\r\n    per_page: perPage,\r\n  };\r\n\r\n  return sdk.listings\r\n    .query(params)\r\n    .then(response => {\r\n      dispatch(addMarketplaceEntities(response));\r\n      dispatch(searchMapListingsSuccess(response));\r\n      return response;\r\n    })\r\n    .catch(e => {\r\n      dispatch(searchMapListingsError(storableError(e)));\r\n      throw e;\r\n    });\r\n};\r\n\r\nexport const loadData = (params, search) => {\r\n  const queryParams = parse(search, {\r\n    latlng: ['origin'],\r\n    latlngBounds: ['bounds'],\r\n  });\r\n\r\n  // Add minStock filter with default value (1), if stock management is in use.\r\n  // This can be overwriten with passed-in query parameters.\r\n  const minStockMaybe = isStockInUse(config) ? { minStock: 1 } : {};\r\n  const { page = 1, address, origin, ...rest } = queryParams;\r\n  const originMaybe = isOriginInUse(config) && origin ? { origin } : {};\r\n\r\n  const { aspectWidth = 1, aspectHeight = 1, variantPrefix = 'listing-card' } = config.listing;\r\n  const aspectRatio = aspectHeight / aspectWidth;\r\n\r\n  return searchListings({\r\n    ...minStockMaybe,\r\n    ...rest,\r\n    ...originMaybe,\r\n    page,\r\n    perPage: RESULT_PAGE_SIZE,\r\n    include: ['author', 'images'],\r\n    'fields.listing': ['title', 'geolocation', 'price'],\r\n    'fields.user': ['profile.displayName', 'profile.abbreviatedName'],\r\n    'fields.image': [`variants.${variantPrefix}`, `variants.${variantPrefix}-2x`],\r\n    ...createImageVariantConfig(`${variantPrefix}`, 400, aspectRatio),\r\n    ...createImageVariantConfig(`${variantPrefix}-2x`, 800, aspectRatio),\r\n    'limit.images': 1,\r\n  });\r\n};\r\n"]},"metadata":{},"sourceType":"module"}