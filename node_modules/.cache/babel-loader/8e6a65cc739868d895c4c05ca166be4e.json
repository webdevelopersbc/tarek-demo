{"ast":null,"code":"var _jsxFileName = \"D:\\\\Amardeep\\\\tarek_project\\\\ftw-product\\\\src\\\\containers\\\\CheckoutPage\\\\CheckoutPage.js\";\nimport React, { Component } from 'react';\nimport { bool, func, instanceOf, object, oneOfType, shape, string } from 'prop-types';\nimport { compose } from 'redux';\nimport { connect } from 'react-redux';\nimport { withRouter } from 'react-router-dom';\nimport classNames from 'classnames'; // Import configs and util modules\n\nimport config from '../../config';\nimport { FormattedMessage, injectIntl, intlShape } from '../../util/reactIntl';\nimport routeConfiguration from '../../routing/routeConfiguration';\nimport { pathByRouteName, findRouteByRouteName } from '../../util/routes';\nimport { propTypes, LINE_ITEM_NIGHT, LINE_ITEM_DAY, DATE_TYPE_DATE } from '../../util/types';\nimport { ensureListing, ensureCurrentUser, ensureUser, ensureTransaction, ensureBooking, ensureStripeCustomer, ensurePaymentMethodCard } from '../../util/data';\nimport { timeOfDayFromLocalToTimeZone, minutesBetween } from '../../util/dates';\nimport { createSlug } from '../../util/urlHelpers';\nimport { isTransactionInitiateAmountTooLowError, isTransactionInitiateListingNotFoundError, isTransactionInitiateMissingStripeAccountError, isTransactionInitiateBookingTimeNotAvailableError, isTransactionInitiateListingInsufficientStockError, isTransactionChargeDisabledError, isTransactionZeroPaymentError, isTransitionQuantityInfoMissingError, transactionInitiateOrderStripeErrors } from '../../util/errors';\nimport { formatMoney } from '../../util/currency';\nimport { TRANSITION_ENQUIRE, txIsPaymentPending, txIsPaymentExpired, txHasPassedPaymentPending } from '../../util/transaction'; // Import global thunk functions\n\nimport { isScrollingDisabled } from '../../ducks/UI.duck';\nimport { confirmCardPayment, retrievePaymentIntent } from '../../ducks/stripe.duck';\nimport { savePaymentMethod } from '../../ducks/paymentMethods.duck'; // Import shared components\n\nimport { AvatarMedium, AspectRatioWrapper, OrderBreakdown, Logo, NamedLink, NamedRedirect, Page, ResponsiveImage } from '../../components'; // Import modules from this directory\n\nimport { initiateOrder, setInitialValues, speculateTransaction, stripeCustomer, confirmPayment, sendMessage } from './CheckoutPage.duck';\nimport StripePaymentForm from './StripePaymentForm/StripePaymentForm';\nimport { storeData, storedData, clearData } from './CheckoutPageSessionHelpers';\nimport css from './CheckoutPage.module.css';\nconst STORAGE_KEY = 'CheckoutPage'; // Stripe PaymentIntent statuses, where user actions are already completed\n// https://stripe.com/docs/payments/payment-intents/status\n\nconst STRIPE_PI_USER_ACTIONS_DONE_STATUSES = ['processing', 'requires_capture', 'succeeded']; // Payment charge options\n\nconst ONETIME_PAYMENT = 'ONETIME_PAYMENT';\nconst PAY_AND_SAVE_FOR_LATER_USE = 'PAY_AND_SAVE_FOR_LATER_USE';\nconst USE_SAVED_CARD = 'USE_SAVED_CARD';\n\nconst paymentFlow = (selectedPaymentMethod, saveAfterOnetimePayment) => {\n  // Payment mode could be 'replaceCard', but without explicit saveAfterOnetimePayment flag,\n  // we'll handle it as one-time payment\n  return selectedPaymentMethod === 'defaultCard' ? USE_SAVED_CARD : saveAfterOnetimePayment ? PAY_AND_SAVE_FOR_LATER_USE : ONETIME_PAYMENT;\n};\n\nconst initializeOrderPage = (initialValues, routes, dispatch) => {\n  const OrderPage = findRouteByRouteName('OrderDetailsPage', routes); // Transaction is already created, but if the initial message\n  // sending failed, we tell it to the OrderDetailsPage.\n\n  dispatch(OrderPage.setInitialValues(initialValues));\n};\n\nconst checkIsPaymentExpired = existingTransaction => {\n  return txIsPaymentExpired(existingTransaction) ? true : txIsPaymentPending(existingTransaction) ? minutesBetween(existingTransaction.attributes.lastTransitionedAt, new Date()) >= 15 : false;\n};\n\nconst getFormattedTotalPrice = (transaction, intl) => {\n  const totalPrice = transaction.attributes.payinTotal;\n  return formatMoney(intl, totalPrice);\n}; // Convert the picked date to moment that will represent the same time of day in UTC time zone.\n\n\nconst bookingDatesMaybe = bookingDates => {\n  const apiTimeZone = 'Etc/UTC';\n  return bookingDates ? {\n    bookingDates: {\n      bookingStart: timeOfDayFromLocalToTimeZone(bookingDates.bookingStart, apiTimeZone),\n      bookingEnd: timeOfDayFromLocalToTimeZone(bookingDates.bookingEnd, apiTimeZone)\n    }\n  } : {};\n}; // Collect error message checks to a single function.\n\n\nconst getErrorMessages = (listingNotFound, initiateOrderError, speculateTransactionError) => {\n  let listingNotFoundErrorMessage = null;\n  let initiateOrderErrorMessage = null;\n  let speculateErrorMessage = null;\n  const isAmountTooLowError = isTransactionInitiateAmountTooLowError(initiateOrderError);\n  const isChargeDisabledError = isTransactionChargeDisabledError(initiateOrderError);\n  const stripeErrors = transactionInitiateOrderStripeErrors(initiateOrderError); // We want to show one error at a time for the real transition\n\n  if (listingNotFound) {\n    listingNotFoundErrorMessage = /*#__PURE__*/React.createElement(FormattedMessage, {\n      id: \"CheckoutPage.listingNotFoundError\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 141,\n        columnNumber: 35\n      }\n    });\n  } else if (isAmountTooLowError) {\n    initiateOrderErrorMessage = /*#__PURE__*/React.createElement(FormattedMessage, {\n      id: \"CheckoutPage.initiateOrderAmountTooLow\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 143,\n        columnNumber: 33\n      }\n    });\n  } else if (isTransactionInitiateBookingTimeNotAvailableError(initiateOrderError)) {\n    // If bookings are used, there could be error related to those\n    initiateOrderErrorMessage = /*#__PURE__*/React.createElement(FormattedMessage, {\n      id: \"CheckoutPage.bookingTimeNotAvailableMessage\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 147,\n        columnNumber: 7\n      }\n    });\n  } else if (isTransitionQuantityInfoMissingError(initiateOrderError)) {\n    initiateOrderErrorMessage = /*#__PURE__*/React.createElement(FormattedMessage, {\n      id: \"CheckoutPage.correctQuantityInformationMissing\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 151,\n        columnNumber: 7\n      }\n    });\n  } else if (isTransactionInitiateListingInsufficientStockError(initiateOrderError)) {\n    // If stock management is used, there could be error related to that\n    initiateOrderErrorMessage = /*#__PURE__*/React.createElement(FormattedMessage, {\n      id: \"CheckoutPage.notEnoughStockMessage\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 155,\n        columnNumber: 33\n      }\n    });\n  } else if (isChargeDisabledError) {\n    initiateOrderErrorMessage = /*#__PURE__*/React.createElement(FormattedMessage, {\n      id: \"CheckoutPage.chargeDisabledMessage\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 157,\n        columnNumber: 33\n      }\n    });\n  } else if (stripeErrors && stripeErrors.length > 0) {\n    // NOTE: Error messages from Stripes are not part of translations.\n    // By default they are in English.\n    const stripeErrorsAsString = stripeErrors.join(', ');\n    initiateOrderErrorMessage = /*#__PURE__*/React.createElement(FormattedMessage, {\n      id: \"CheckoutPage.initiateOrderStripeError\",\n      values: {\n        stripeErrors: stripeErrorsAsString\n      },\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 163,\n        columnNumber: 7\n      }\n    });\n  } else if (initiateOrderError) {\n    // Generic initiate order error\n    initiateOrderErrorMessage = /*#__PURE__*/React.createElement(FormattedMessage, {\n      id: \"CheckoutPage.initiateOrderError\",\n      values: {\n        listingLink\n      },\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 171,\n        columnNumber: 7\n      }\n    });\n  } // We want to show one error at a time for speculateTransition\n\n\n  if (isTransactionInitiateMissingStripeAccountError(speculateTransactionError)) {\n    speculateErrorMessage = /*#__PURE__*/React.createElement(FormattedMessage, {\n      id: \"CheckoutPage.providerStripeAccountMissingError\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 178,\n        columnNumber: 7\n      }\n    });\n  } else if (isTransactionInitiateBookingTimeNotAvailableError(speculateTransactionError)) {\n    speculateErrorMessage = /*#__PURE__*/React.createElement(FormattedMessage, {\n      id: \"CheckoutPage.bookingTimeNotAvailableMessage\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 181,\n        columnNumber: 29\n      }\n    });\n  } else if (isTransactionInitiateListingInsufficientStockError(speculateTransactionError)) {\n    speculateErrorMessage = /*#__PURE__*/React.createElement(FormattedMessage, {\n      id: \"CheckoutPage.notEnoughStockMessage\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 183,\n        columnNumber: 29\n      }\n    });\n  } else if (isTransactionZeroPaymentError(speculateTransactionError)) {\n    speculateErrorMessage = /*#__PURE__*/React.createElement(FormattedMessage, {\n      id: \"CheckoutPage.initiateOrderAmountTooLow\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 185,\n        columnNumber: 29\n      }\n    });\n  } else if (isTransitionQuantityInfoMissingError(speculateTransactionError)) {\n    speculateErrorMessage = /*#__PURE__*/React.createElement(FormattedMessage, {\n      id: \"CheckoutPage.correctQuantityInformationMissing\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 188,\n        columnNumber: 7\n      }\n    });\n  } else if (speculateTransactionError) {\n    speculateErrorMessage = /*#__PURE__*/React.createElement(FormattedMessage, {\n      id: \"CheckoutPage.speculateFailedMessage\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 191,\n        columnNumber: 29\n      }\n    });\n  } // Add paragraph-container for the error message, if it exists\n\n\n  const listingNotFoundErrorMessageParagraph = listingNotFoundErrorMessage ? /*#__PURE__*/React.createElement(\"p\", {\n    className: css.notFoundError,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 196,\n      columnNumber: 5\n    }\n  }, listingNotFoundErrorMessage) : null;\n  const initiateOrderErrorMessageParagraph = initiateOrderErrorMessage ? /*#__PURE__*/React.createElement(\"p\", {\n    className: css.orderError,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 199,\n      columnNumber: 5\n    }\n  }, initiateOrderErrorMessage) : null;\n  const speculateErrorMessageParagraph = speculateErrorMessage ? /*#__PURE__*/React.createElement(\"p\", {\n    className: css.orderError,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 202,\n      columnNumber: 5\n    }\n  }, speculateErrorMessage) : null;\n  const speculateTransactionErrorMessageParagraph = speculateTransactionError ? /*#__PURE__*/React.createElement(\"p\", {\n    className: css.speculateError,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 205,\n      columnNumber: 5\n    }\n  }, /*#__PURE__*/React.createElement(FormattedMessage, {\n    id: \"CheckoutPage.speculateTransactionError\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 206,\n      columnNumber: 7\n    }\n  })) : null;\n  return {\n    listingNotFoundErrorMessage: listingNotFoundErrorMessageParagraph,\n    initiateOrderErrorMessage: initiateOrderErrorMessageParagraph,\n    speculateErrorMessage: speculateErrorMessageParagraph,\n    speculateTransactionErrorMessage: speculateTransactionErrorMessageParagraph\n  };\n};\n\nexport class CheckoutPageComponent extends Component {\n  constructor(props) {\n    super(props);\n    this.state = {\n      pageData: {},\n      dataLoaded: false,\n      submitting: false\n    };\n    this.stripe = null;\n    this.onStripeInitialized = this.onStripeInitialized.bind(this);\n    this.loadInitialData = this.loadInitialData.bind(this);\n    this.handlePaymentIntent = this.handlePaymentIntent.bind(this);\n    this.handleSubmit = this.handleSubmit.bind(this);\n  }\n\n  componentDidMount() {\n    if (window) {\n      this.loadInitialData();\n    }\n  }\n  /**\r\n   * Load initial data for the page\r\n   *\r\n   * Since the data for the checkout is not passed in the URL (there\r\n   * might be lots of options in the future), we must pass in the data\r\n   * some other way. Currently the ListingPage sets the initial data\r\n   * for the CheckoutPage's Redux store.\r\n   *\r\n   * For some cases (e.g. a refresh in the CheckoutPage), the Redux\r\n   * store is empty. To handle that case, we store the received data\r\n   * to window.sessionStorage and read it from there if no props from\r\n   * the store exist.\r\n   *\r\n   * This function also sets of fetching the speculative transaction\r\n   * based on this initial data.\r\n   */\n\n\n  loadInitialData() {\n    const {\n      orderData,\n      listing,\n      transaction,\n      fetchSpeculatedTransaction,\n      fetchStripeCustomer,\n      history\n    } = this.props; // Fetch currentUser with stripeCustomer entity\n    // Note: since there's need for data loading in \"componentWillMount\" function,\n    //       this is added here instead of loadData static function.\n\n    fetchStripeCustomer(); // Browser's back navigation should not rewrite data in session store.\n    // Action is 'POP' on both history.back() and page refresh cases.\n    // Action is 'PUSH' when user has directed through a link\n    // Action is 'REPLACE' when user has directed through login/signup process\n\n    const hasNavigatedThroughLink = history.action === 'PUSH' || history.action === 'REPLACE';\n    const hasDataInProps = !!(orderData && listing && hasNavigatedThroughLink);\n\n    if (hasDataInProps) {\n      // Store data only if data is passed through props and user has navigated through a link.\n      storeData(orderData, listing, transaction, STORAGE_KEY);\n    } // NOTE: stored data can be empty if user has already successfully completed transaction.\n\n\n    const pageData = hasDataInProps ? {\n      orderData,\n      listing,\n      transaction\n    } : storedData(STORAGE_KEY);\n    const tx = pageData ? pageData.transaction : null; // If transaction has passed payment-pending state, speculated tx is not needed.\n\n    const shouldFetchSpeculatedTransaction = pageData && pageData.listing && pageData.listing.id && pageData.orderData && !txHasPassedPaymentPending(tx);\n\n    if (shouldFetchSpeculatedTransaction) {\n      var _pageData$orderData, _pageData$orderData2;\n\n      const listingId = pageData.listing.id;\n      const transactionId = tx ? tx.id : null; // Fetch speculated transaction for showing price in order breakdown\n      // NOTE: if unit type is line-item/units, quantity needs to be added.\n      // The way to pass it to checkout page is through pageData.orderData\n\n      const quantity = (_pageData$orderData = pageData.orderData) === null || _pageData$orderData === void 0 ? void 0 : _pageData$orderData.quantity;\n      const quantityMaybe = quantity ? {\n        quantity\n      } : {};\n      const deliveryMethod = (_pageData$orderData2 = pageData.orderData) === null || _pageData$orderData2 === void 0 ? void 0 : _pageData$orderData2.deliveryMethod;\n      fetchSpeculatedTransaction({\n        listingId,\n        deliveryMethod,\n        ...quantityMaybe,\n        ...bookingDatesMaybe(pageData.orderData.bookingDates)\n      }, transactionId);\n    }\n\n    this.setState({\n      pageData: pageData || {},\n      dataLoaded: true\n    });\n  }\n\n  handlePaymentIntent(handlePaymentParams) {\n    var _pageData$orderData3, _pageData$orderData4;\n\n    const {\n      currentUser,\n      stripeCustomerFetched,\n      onInitiateOrder,\n      onConfirmCardPayment,\n      onConfirmPayment,\n      onSendMessage,\n      onSavePaymentMethod\n    } = this.props;\n    const {\n      pageData,\n      speculatedTransaction,\n      message,\n      paymentIntent,\n      selectedPaymentMethod,\n      saveAfterOnetimePayment,\n      shippingDetails\n    } = handlePaymentParams;\n    const storedTx = ensureTransaction(pageData.transaction);\n    const ensuredCurrentUser = ensureCurrentUser(currentUser);\n    const ensuredStripeCustomer = ensureStripeCustomer(ensuredCurrentUser.stripeCustomer);\n    const ensuredDefaultPaymentMethod = ensurePaymentMethodCard(ensuredStripeCustomer.defaultPaymentMethod);\n    let createdPaymentIntent = null;\n    const hasDefaultPaymentMethod = !!(stripeCustomerFetched && ensuredStripeCustomer.attributes.stripeCustomerId && ensuredDefaultPaymentMethod.id);\n    const stripePaymentMethodId = hasDefaultPaymentMethod ? ensuredDefaultPaymentMethod.attributes.stripePaymentMethodId : null;\n    const selectedPaymentFlow = paymentFlow(selectedPaymentMethod, saveAfterOnetimePayment); // Step 1: initiate order by requesting payment from Marketplace API\n\n    const fnRequestPayment = fnParams => {\n      // fnParams should be { listingId, deliveryMethod, quantity?, bookingDates?, paymentMethod?/setupPaymentMethodForSaving? }\n      const hasPaymentIntents = storedTx.attributes.protectedData && storedTx.attributes.protectedData.stripePaymentIntents; // If paymentIntent exists, order has been initiated previously.\n\n      return hasPaymentIntents ? Promise.resolve(storedTx) : onInitiateOrder(fnParams, storedTx.id);\n    }; // Step 2: pay using Stripe SDK\n\n\n    const fnConfirmCardPayment = fnParams => {\n      // fnParams should be returned transaction entity\n      const order = ensureTransaction(fnParams);\n\n      if (order.id) {\n        // Store order.\n        const {\n          orderData,\n          listing\n        } = pageData;\n        storeData(orderData, listing, order, STORAGE_KEY);\n        this.setState({\n          pageData: { ...pageData,\n            transaction: order\n          }\n        });\n      }\n\n      const hasPaymentIntents = order.attributes.protectedData && order.attributes.protectedData.stripePaymentIntents;\n\n      if (!hasPaymentIntents) {\n        throw new Error(`Missing StripePaymentIntents key in transaction's protectedData. Check that your transaction process is configured to use payment intents.`);\n      }\n\n      const {\n        stripePaymentIntentClientSecret\n      } = hasPaymentIntents ? order.attributes.protectedData.stripePaymentIntents.default : null;\n      const {\n        stripe,\n        card,\n        billingDetails,\n        paymentIntent\n      } = handlePaymentParams;\n      const stripeElementMaybe = selectedPaymentFlow !== USE_SAVED_CARD ? {\n        card\n      } : {}; // Note: For basic USE_SAVED_CARD scenario, we have set it already on API side, when PaymentIntent was created.\n      // However, the payment_method is save here for USE_SAVED_CARD flow if customer first attempted onetime payment\n\n      const paymentParams = selectedPaymentFlow !== USE_SAVED_CARD ? {\n        payment_method: {\n          billing_details: billingDetails,\n          card: card\n        }\n      } : {\n        payment_method: stripePaymentMethodId\n      };\n      const params = {\n        stripePaymentIntentClientSecret,\n        orderId: order.id,\n        stripe,\n        ...stripeElementMaybe,\n        paymentParams\n      }; // If paymentIntent status is not waiting user action,\n      // confirmCardPayment has been called previously.\n\n      const hasPaymentIntentUserActionsDone = paymentIntent && STRIPE_PI_USER_ACTIONS_DONE_STATUSES.includes(paymentIntent.status);\n      return hasPaymentIntentUserActionsDone ? Promise.resolve({\n        transactionId: order.id,\n        paymentIntent\n      }) : onConfirmCardPayment(params);\n    }; // Step 3: complete order by confirming payment to Marketplace API\n    // Parameter should contain { paymentIntent, transactionId } returned in step 2\n\n\n    const fnConfirmPayment = fnParams => {\n      createdPaymentIntent = fnParams.paymentIntent;\n      return onConfirmPayment(fnParams);\n    }; // Step 4: send initial message\n\n\n    const fnSendMessage = fnParams => {\n      return onSendMessage({ ...fnParams,\n        message\n      });\n    }; // Step 5: optionally save card as defaultPaymentMethod\n\n\n    const fnSavePaymentMethod = fnParams => {\n      const pi = createdPaymentIntent || paymentIntent;\n\n      if (selectedPaymentFlow === PAY_AND_SAVE_FOR_LATER_USE) {\n        return onSavePaymentMethod(ensuredStripeCustomer, pi.payment_method).then(response => {\n          if (response.errors) {\n            return { ...fnParams,\n              paymentMethodSaved: false\n            };\n          }\n\n          return { ...fnParams,\n            paymentMethodSaved: true\n          };\n        }).catch(e => {\n          // Real error cases are catched already in paymentMethods page.\n          return { ...fnParams,\n            paymentMethodSaved: false\n          };\n        });\n      } else {\n        return Promise.resolve({ ...fnParams,\n          paymentMethodSaved: true\n        });\n      }\n    }; // Here we create promise calls in sequence\n    // This is pretty much the same as:\n    // fnRequestPayment({...initialParams})\n    //   .then(result => fnConfirmCardPayment({...result}))\n    //   .then(result => fnConfirmPayment({...result}))\n\n\n    const applyAsync = (acc, val) => acc.then(val);\n\n    const composeAsync = (...funcs) => x => funcs.reduce(applyAsync, Promise.resolve(x));\n\n    const handlePaymentIntentCreation = composeAsync(fnRequestPayment, fnConfirmCardPayment, fnConfirmPayment, fnSendMessage, fnSavePaymentMethod); // Create order aka transaction\n    // NOTE: if unit type is line-item/units, quantity needs to be added.\n    // The way to pass it to checkout page is through pageData.orderData\n\n    const tx = speculatedTransaction ? speculatedTransaction : storedTx;\n    const deliveryMethod = (_pageData$orderData3 = pageData.orderData) === null || _pageData$orderData3 === void 0 ? void 0 : _pageData$orderData3.deliveryMethod;\n    const quantity = (_pageData$orderData4 = pageData.orderData) === null || _pageData$orderData4 === void 0 ? void 0 : _pageData$orderData4.quantity;\n    const quantityMaybe = quantity ? {\n      quantity\n    } : {};\n    const protectedDataMaybe = deliveryMethod && shippingDetails ? {\n      protectedData: {\n        deliveryMethod,\n        shippingDetails\n      }\n    } : deliveryMethod ? {\n      protectedData: {\n        deliveryMethod\n      }\n    } : {}; // Note: optionalPaymentParams contains Stripe paymentMethod,\n    // but that can also be passed on Step 2\n    // stripe.confirmCardPayment(stripe, { payment_method: stripePaymentMethodId })\n\n    const optionalPaymentParams = selectedPaymentFlow === USE_SAVED_CARD && hasDefaultPaymentMethod ? {\n      paymentMethod: stripePaymentMethodId\n    } : selectedPaymentFlow === PAY_AND_SAVE_FOR_LATER_USE ? {\n      setupPaymentMethodForSaving: true\n    } : {};\n    const orderParams = {\n      listingId: pageData.listing.id,\n      deliveryMethod,\n      ...quantityMaybe,\n      ...bookingDatesMaybe(pageData.orderData.bookingDates),\n      ...protectedDataMaybe,\n      ...optionalPaymentParams\n    };\n    return handlePaymentIntentCreation(orderParams);\n  }\n\n  handleSubmit(values) {\n    if (this.state.submitting) {\n      return;\n    }\n\n    this.setState({\n      submitting: true\n    });\n    const {\n      history,\n      speculatedTransaction,\n      currentUser,\n      paymentIntent,\n      dispatch\n    } = this.props;\n    const {\n      card,\n      message,\n      paymentMethod,\n      formValues\n    } = values;\n    const {\n      name,\n      addressLine1,\n      addressLine2,\n      postal,\n      city,\n      state,\n      country,\n      saveAfterOnetimePayment,\n      recipientName,\n      recipientPhoneNumber,\n      recipientAddressLine1,\n      recipientAddressLine2,\n      recipientPostal,\n      recipientCity,\n      recipientState,\n      recipientCountry\n    } = formValues; // Billing address is recommended.\n    // However, let's not assume that <StripePaymentAddress> data is among formValues.\n    // Read more about this from Stripe's docs\n    // https://stripe.com/docs/stripe-js/reference#stripe-handle-card-payment-no-element\n\n    const addressMaybe = addressLine1 && postal ? {\n      address: {\n        city: city,\n        country: country,\n        line1: addressLine1,\n        line2: addressLine2,\n        postal_code: postal,\n        state: state\n      }\n    } : {};\n    const billingDetails = {\n      name,\n      email: ensureCurrentUser(currentUser).attributes.email,\n      ...addressMaybe\n    };\n    const shippingDetailsMaybe = recipientName && recipientAddressLine1 && recipientPostal ? {\n      shippingDetails: {\n        name: recipientName,\n        phoneNumber: recipientPhoneNumber,\n        address: {\n          city: recipientCity,\n          country: recipientCountry,\n          line1: recipientAddressLine1,\n          line2: recipientAddressLine2,\n          postalCode: recipientPostal,\n          state: recipientState\n        }\n      }\n    } : {};\n    const requestPaymentParams = {\n      pageData: this.state.pageData,\n      speculatedTransaction,\n      stripe: this.stripe,\n      card,\n      billingDetails,\n      message,\n      paymentIntent,\n      selectedPaymentMethod: paymentMethod,\n      saveAfterOnetimePayment: !!saveAfterOnetimePayment,\n      ...shippingDetailsMaybe\n    };\n    this.handlePaymentIntent(requestPaymentParams).then(res => {\n      const {\n        orderId,\n        messageSuccess,\n        paymentMethodSaved\n      } = res;\n      this.setState({\n        submitting: false\n      });\n      const routes = routeConfiguration();\n      const initialMessageFailedToTransaction = messageSuccess ? null : orderId;\n      const orderDetailsPath = pathByRouteName('OrderDetailsPage', routes, {\n        id: orderId.uuid\n      });\n      const initialValues = {\n        initialMessageFailedToTransaction,\n        savePaymentMethodFailed: !paymentMethodSaved\n      };\n      initializeOrderPage(initialValues, routes, dispatch);\n      clearData(STORAGE_KEY);\n      history.push(orderDetailsPath);\n    }).catch(err => {\n      console.error(err);\n      this.setState({\n        submitting: false\n      });\n    });\n  }\n\n  onStripeInitialized(stripe) {\n    this.stripe = stripe;\n    const {\n      paymentIntent,\n      onRetrievePaymentIntent\n    } = this.props;\n    const tx = this.state.pageData ? this.state.pageData.transaction : null; // We need to get up to date PI, if payment is pending but it's not expired.\n\n    const shouldFetchPaymentIntent = this.stripe && !paymentIntent && tx && tx.id && txIsPaymentPending(tx) && !checkIsPaymentExpired(tx);\n\n    if (shouldFetchPaymentIntent) {\n      const {\n        stripePaymentIntentClientSecret\n      } = tx.attributes.protectedData && tx.attributes.protectedData.stripePaymentIntents ? tx.attributes.protectedData.stripePaymentIntents.default : {}; // Fetch up to date PaymentIntent from Stripe\n\n      onRetrievePaymentIntent({\n        stripe,\n        stripePaymentIntentClientSecret\n      });\n    }\n  }\n\n  render() {\n    var _tx$booking, _tx$attributes$lineIt, _firstImage$attribute, _currentListing$attri, _currentListing$attri2;\n\n    const {\n      scrollingDisabled,\n      speculateTransactionInProgress,\n      speculateTransactionError,\n      speculatedTransaction: speculatedTransactionMaybe,\n      initiateOrderError,\n      confirmPaymentError,\n      intl,\n      params,\n      currentUser,\n      confirmCardPaymentError,\n      paymentIntent,\n      retrievePaymentIntentError,\n      stripeCustomerFetched\n    } = this.props; // Since the listing data is already given from the ListingPage\n    // and stored to handle refreshes, it might not have the possible\n    // deleted or closed information in it. If the transaction\n    // initiate or the speculative initiate fail due to the listing\n    // being deleted or closec, we should dig the information from the\n    // errors and not the listing data.\n\n    const listingNotFound = isTransactionInitiateListingNotFoundError(speculateTransactionError) || isTransactionInitiateListingNotFoundError(initiateOrderError);\n    const {\n      listingNotFoundErrorMessage,\n      initiateOrderErrorMessage,\n      speculateErrorMessage,\n      speculateTransactionErrorMessage\n    } = getErrorMessages(listingNotFound, initiateOrderError, speculateTransactionError);\n    const isLoading = !this.state.dataLoaded || speculateTransactionInProgress;\n    const {\n      listing,\n      transaction,\n      orderData\n    } = this.state.pageData;\n    const existingTransaction = ensureTransaction(transaction);\n    const speculatedTransaction = ensureTransaction(speculatedTransactionMaybe, {}, null);\n    const currentListing = ensureListing(listing);\n    const currentAuthor = ensureUser(currentListing.author);\n    const listingTitle = currentListing.attributes.title;\n    const title = intl.formatMessage({\n      id: 'CheckoutPage.title'\n    }, {\n      listingTitle\n    });\n    const pageProps = {\n      title,\n      scrollingDisabled\n    };\n    const topbar = /*#__PURE__*/React.createElement(\"div\", {\n      className: css.topbar,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 688,\n        columnNumber: 7\n      }\n    }, /*#__PURE__*/React.createElement(NamedLink, {\n      className: css.home,\n      name: \"LandingPage\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 689,\n        columnNumber: 9\n      }\n    }, /*#__PURE__*/React.createElement(Logo, {\n      className: css.logoMobile,\n      title: intl.formatMessage({\n        id: 'CheckoutPage.goToLandingPage'\n      }),\n      format: \"mobile\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 690,\n        columnNumber: 11\n      }\n    }), /*#__PURE__*/React.createElement(Logo, {\n      className: css.logoDesktop,\n      alt: intl.formatMessage({\n        id: 'CheckoutPage.goToLandingPage'\n      }),\n      format: \"desktop\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 695,\n        columnNumber: 11\n      }\n    })));\n\n    if (isLoading) {\n      return /*#__PURE__*/React.createElement(Page, Object.assign({}, pageProps, {\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 705,\n          columnNumber: 14\n        }\n      }), topbar);\n    }\n\n    const isOwnListing = currentUser && currentUser.id && currentAuthor && currentAuthor.id && currentAuthor.id.uuid === currentUser.id.uuid;\n    const hasRequiredData = !!(currentListing.id && currentAuthor.id);\n    const canShowPage = hasRequiredData && !isOwnListing;\n    const shouldRedirect = !isLoading && !canShowPage; // Redirect back to ListingPage if data is missing.\n    // Redirection must happen before any data format error is thrown (e.g. wrong currency)\n\n    if (shouldRedirect) {\n      // eslint-disable-next-line no-console\n      console.error('Missing or invalid data for checkout, redirecting back to listing page.', {\n        transaction: speculatedTransaction,\n        listing\n      });\n      return /*#__PURE__*/React.createElement(NamedRedirect, {\n        name: \"ListingPage\",\n        params: params,\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 727,\n          columnNumber: 14\n        }\n      });\n    } // Show breakdown only when (speculated?) transaction is loaded\n    // (i.e. have an id and lineItems)\n\n\n    const tx = existingTransaction.booking ? existingTransaction : speculatedTransaction;\n    const txBookingMaybe = ((_tx$booking = tx.booking) === null || _tx$booking === void 0 ? void 0 : _tx$booking.id) ? {\n      booking: ensureBooking(tx.booking),\n      dateType: DATE_TYPE_DATE\n    } : {};\n    const breakdown = tx.id && ((_tx$attributes$lineIt = tx.attributes.lineItems) === null || _tx$attributes$lineIt === void 0 ? void 0 : _tx$attributes$lineIt.length) > 0 ? /*#__PURE__*/React.createElement(OrderBreakdown, Object.assign({\n      className: css.orderBreakdown,\n      userRole: \"customer\",\n      unitType: config.lineItemUnitType,\n      transaction: tx\n    }, txBookingMaybe, {\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 738,\n        columnNumber: 9\n      }\n    })) : null;\n    const isPaymentExpired = checkIsPaymentExpired(existingTransaction);\n    const hasDefaultPaymentMethod = !!(stripeCustomerFetched && ensureStripeCustomer(currentUser.stripeCustomer).attributes.stripeCustomerId && ensurePaymentMethodCard(currentUser.stripeCustomer.defaultPaymentMethod).id); // Allow showing page when currentUser is still being downloaded,\n    // but show payment form only when user info is loaded.\n\n    const showPaymentForm = !!(currentUser && hasRequiredData && !listingNotFound && !initiateOrderError && !speculateTransactionError && !retrievePaymentIntentError && !isPaymentExpired);\n    const firstImage = currentListing.images && currentListing.images.length > 0 ? currentListing.images[0] : null;\n    const {\n      aspectWidth = 1,\n      aspectHeight = 1,\n      variantPrefix = 'listing-card'\n    } = config.listing;\n    const variants = firstImage ? Object.keys(firstImage === null || firstImage === void 0 ? void 0 : (_firstImage$attribute = firstImage.attributes) === null || _firstImage$attribute === void 0 ? void 0 : _firstImage$attribute.variants).filter(k => k.startsWith(variantPrefix)) : [];\n    const listingLink = /*#__PURE__*/React.createElement(NamedLink, {\n      name: \"ListingPage\",\n      params: {\n        id: currentListing.id.uuid,\n        slug: createSlug(listingTitle)\n      },\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 775,\n        columnNumber: 7\n      }\n    }, /*#__PURE__*/React.createElement(FormattedMessage, {\n      id: \"CheckoutPage.errorlistingLinkText\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 779,\n        columnNumber: 9\n      }\n    }));\n    const unitType = config.lineItemUnitType;\n    const isNightly = unitType === LINE_ITEM_NIGHT;\n    const isDaily = unitType === LINE_ITEM_DAY;\n    const unitTranslationKey = isNightly ? 'CheckoutPage.perNight' : isDaily ? 'CheckoutPage.perDay' : 'CheckoutPage.perUnit';\n    const price = currentListing.attributes.price;\n    const formattedPrice = formatMoney(intl, price);\n    const detailsSubTitle = `${formattedPrice} ${intl.formatMessage({\n      id: unitTranslationKey\n    })}`;\n    const showInitialMessageInput = !(existingTransaction && existingTransaction.attributes.lastTransition === TRANSITION_ENQUIRE); // Get first and last name of the current user and use it in the StripePaymentForm to autofill the name field\n\n    const userName = currentUser && currentUser.attributes ? `${currentUser.attributes.profile.firstName} ${currentUser.attributes.profile.lastName}` : null; // If paymentIntent status is not waiting user action,\n    // confirmCardPayment has been called previously.\n\n    const hasPaymentIntentUserActionsDone = paymentIntent && STRIPE_PI_USER_ACTIONS_DONE_STATUSES.includes(paymentIntent.status); // If your marketplace works mostly in one country you can use initial values to select country automatically\n    // e.g. {country: 'FI'}\n\n    const initalValuesForStripePayment = {\n      name: userName,\n      recipientName: userName\n    };\n    return /*#__PURE__*/React.createElement(Page, Object.assign({}, pageProps, {\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 818,\n        columnNumber: 7\n      }\n    }), topbar, /*#__PURE__*/React.createElement(\"div\", {\n      className: css.contentContainer,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 820,\n        columnNumber: 9\n      }\n    }, /*#__PURE__*/React.createElement(AspectRatioWrapper, {\n      width: aspectWidth,\n      height: aspectHeight,\n      className: css.aspectWrapper,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 821,\n        columnNumber: 11\n      }\n    }, /*#__PURE__*/React.createElement(ResponsiveImage, {\n      rootClassName: css.rootForImage,\n      alt: listingTitle,\n      image: firstImage,\n      variants: variants,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 826,\n        columnNumber: 13\n      }\n    })), /*#__PURE__*/React.createElement(\"div\", {\n      className: classNames(css.avatarWrapper, css.avatarMobile),\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 833,\n        columnNumber: 11\n      }\n    }, /*#__PURE__*/React.createElement(AvatarMedium, {\n      user: currentAuthor,\n      disableProfileLink: true,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 834,\n        columnNumber: 13\n      }\n    })), /*#__PURE__*/React.createElement(\"div\", {\n      className: css.bookListingContainer,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 836,\n        columnNumber: 11\n      }\n    }, /*#__PURE__*/React.createElement(\"div\", {\n      className: css.heading,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 837,\n        columnNumber: 13\n      }\n    }, /*#__PURE__*/React.createElement(\"h1\", {\n      className: css.title,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 838,\n        columnNumber: 15\n      }\n    }, title), /*#__PURE__*/React.createElement(\"div\", {\n      className: css.author,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 839,\n        columnNumber: 15\n      }\n    }, /*#__PURE__*/React.createElement(FormattedMessage, {\n      id: \"CheckoutPage.providerInfo\",\n      values: {\n        name: currentAuthor.attributes.profile.displayName\n      },\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 840,\n        columnNumber: 17\n      }\n    }))), /*#__PURE__*/React.createElement(\"div\", {\n      className: css.priceBreakdownContainer,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 847,\n        columnNumber: 13\n      }\n    }, speculateTransactionErrorMessage, breakdown), /*#__PURE__*/React.createElement(\"section\", {\n      className: css.paymentContainer,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 852,\n        columnNumber: 13\n      }\n    }, initiateOrderErrorMessage, listingNotFoundErrorMessage, speculateErrorMessage, retrievePaymentIntentError ? /*#__PURE__*/React.createElement(\"p\", {\n      className: css.orderError,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 857,\n        columnNumber: 17\n      }\n    }, /*#__PURE__*/React.createElement(FormattedMessage, {\n      id: \"CheckoutPage.retrievingStripePaymentIntentFailed\",\n      values: {\n        listingLink\n      },\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 858,\n        columnNumber: 19\n      }\n    })) : null, showPaymentForm ? /*#__PURE__*/React.createElement(StripePaymentForm, {\n      className: css.paymentForm,\n      onSubmit: this.handleSubmit,\n      inProgress: this.state.submitting,\n      formId: \"CheckoutPagePaymentForm\",\n      authorDisplayName: currentAuthor.attributes.profile.displayName,\n      showInitialMessageInput: showInitialMessageInput,\n      initialValues: initalValuesForStripePayment,\n      initiateOrderError: initiateOrderError,\n      confirmCardPaymentError: confirmCardPaymentError,\n      confirmPaymentError: confirmPaymentError,\n      hasHandledCardPayment: hasPaymentIntentUserActionsDone,\n      loadingData: !stripeCustomerFetched,\n      defaultPaymentMethod: hasDefaultPaymentMethod ? currentUser.stripeCustomer.defaultPaymentMethod : null,\n      paymentIntent: paymentIntent,\n      onStripeInitialized: this.onStripeInitialized,\n      askShippingDetails: (orderData === null || orderData === void 0 ? void 0 : orderData.deliveryMethod) === 'shipping',\n      pickupLocation: currentListing === null || currentListing === void 0 ? void 0 : (_currentListing$attri = currentListing.attributes) === null || _currentListing$attri === void 0 ? void 0 : (_currentListing$attri2 = _currentListing$attri.publicData) === null || _currentListing$attri2 === void 0 ? void 0 : _currentListing$attri2.location,\n      totalPrice: tx.id ? getFormattedTotalPrice(tx, intl) : null,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 865,\n        columnNumber: 17\n      }\n    }) : null, isPaymentExpired ? /*#__PURE__*/React.createElement(\"p\", {\n      className: css.orderError,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 889,\n        columnNumber: 17\n      }\n    }, /*#__PURE__*/React.createElement(FormattedMessage, {\n      id: \"CheckoutPage.paymentExpiredMessage\",\n      values: {\n        listingLink\n      },\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 890,\n        columnNumber: 19\n      }\n    })) : null)), /*#__PURE__*/React.createElement(\"div\", {\n      className: css.detailsContainerDesktop,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 899,\n        columnNumber: 11\n      }\n    }, /*#__PURE__*/React.createElement(AspectRatioWrapper, {\n      width: aspectWidth,\n      height: aspectHeight,\n      className: css.detailsAspectWrapper,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 900,\n        columnNumber: 13\n      }\n    }, /*#__PURE__*/React.createElement(ResponsiveImage, {\n      rootClassName: css.rootForImage,\n      alt: listingTitle,\n      image: firstImage,\n      variants: variants,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 905,\n        columnNumber: 15\n      }\n    })), /*#__PURE__*/React.createElement(\"div\", {\n      className: css.avatarWrapper,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 912,\n        columnNumber: 13\n      }\n    }, /*#__PURE__*/React.createElement(AvatarMedium, {\n      user: currentAuthor,\n      disableProfileLink: true,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 913,\n        columnNumber: 15\n      }\n    })), /*#__PURE__*/React.createElement(\"div\", {\n      className: css.detailsHeadings,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 915,\n        columnNumber: 13\n      }\n    }, /*#__PURE__*/React.createElement(\"h2\", {\n      className: css.detailsTitle,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 916,\n        columnNumber: 15\n      }\n    }, listingTitle), /*#__PURE__*/React.createElement(\"p\", {\n      className: css.detailsSubtitle,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 917,\n        columnNumber: 15\n      }\n    }, detailsSubTitle)), speculateTransactionErrorMessage, /*#__PURE__*/React.createElement(\"h2\", {\n      className: css.orderBreakdownTitle,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 920,\n        columnNumber: 13\n      }\n    }, /*#__PURE__*/React.createElement(FormattedMessage, {\n      id: \"CheckoutPage.orderBreakdown\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 921,\n        columnNumber: 15\n      }\n    })), breakdown)));\n  }\n\n}\nCheckoutPageComponent.defaultProps = {\n  initiateOrderError: null,\n  confirmPaymentError: null,\n  listing: null,\n  orderData: {},\n  speculateTransactionError: null,\n  speculatedTransaction: null,\n  transaction: null,\n  currentUser: null,\n  paymentIntent: null\n};\nCheckoutPageComponent.propTypes = {\n  scrollingDisabled: bool.isRequired,\n  listing: propTypes.listing,\n  orderData: object,\n  fetchStripeCustomer: func.isRequired,\n  stripeCustomerFetched: bool.isRequired,\n  fetchSpeculatedTransaction: func.isRequired,\n  speculateTransactionInProgress: bool.isRequired,\n  speculateTransactionError: propTypes.error,\n  speculatedTransaction: propTypes.transaction,\n  transaction: propTypes.transaction,\n  currentUser: propTypes.currentUser,\n  params: shape({\n    id: string,\n    slug: string\n  }).isRequired,\n  onConfirmPayment: func.isRequired,\n  onInitiateOrder: func.isRequired,\n  onConfirmCardPayment: func.isRequired,\n  onRetrievePaymentIntent: func.isRequired,\n  onSavePaymentMethod: func.isRequired,\n  onSendMessage: func.isRequired,\n  initiateOrderError: propTypes.error,\n  confirmPaymentError: propTypes.error,\n  // confirmCardPaymentError comes from Stripe so that's why we can't expect it to be in a specific form\n  confirmCardPaymentError: oneOfType([propTypes.error, object]),\n  paymentIntent: object,\n  // from connect\n  dispatch: func.isRequired,\n  // from injectIntl\n  intl: intlShape.isRequired,\n  // from withRouter\n  history: shape({\n    push: func.isRequired\n  }).isRequired\n};\n\nconst mapStateToProps = state => {\n  const {\n    listing,\n    orderData,\n    stripeCustomerFetched,\n    speculateTransactionInProgress,\n    speculateTransactionError,\n    speculatedTransaction,\n    transaction,\n    initiateOrderError,\n    confirmPaymentError\n  } = state.CheckoutPage;\n  const {\n    currentUser\n  } = state.user;\n  const {\n    confirmCardPaymentError,\n    paymentIntent,\n    retrievePaymentIntentError\n  } = state.stripe;\n  return {\n    scrollingDisabled: isScrollingDisabled(state),\n    currentUser,\n    stripeCustomerFetched,\n    orderData,\n    speculateTransactionInProgress,\n    speculateTransactionError,\n    speculatedTransaction,\n    transaction,\n    listing,\n    initiateOrderError,\n    confirmCardPaymentError,\n    confirmPaymentError,\n    paymentIntent,\n    retrievePaymentIntentError\n  };\n};\n\nconst mapDispatchToProps = dispatch => ({\n  dispatch,\n  fetchSpeculatedTransaction: (params, transactionId) => dispatch(speculateTransaction(params, transactionId)),\n  fetchStripeCustomer: () => dispatch(stripeCustomer()),\n  onInitiateOrder: (params, transactionId) => dispatch(initiateOrder(params, transactionId)),\n  onRetrievePaymentIntent: params => dispatch(retrievePaymentIntent(params)),\n  onConfirmCardPayment: params => dispatch(confirmCardPayment(params)),\n  onConfirmPayment: params => dispatch(confirmPayment(params)),\n  onSendMessage: params => dispatch(sendMessage(params)),\n  onSavePaymentMethod: (stripeCustomer, stripePaymentMethodId) => dispatch(savePaymentMethod(stripeCustomer, stripePaymentMethodId))\n});\n\nconst CheckoutPage = compose(withRouter, connect(mapStateToProps, mapDispatchToProps), injectIntl)(CheckoutPageComponent);\n\nCheckoutPage.setInitialValues = (initialValues, saveToSessionStorage = false) => {\n  if (saveToSessionStorage) {\n    const {\n      listing,\n      orderData\n    } = initialValues;\n    storeData(orderData, listing, null, STORAGE_KEY);\n  }\n\n  return setInitialValues(initialValues);\n};\n\nCheckoutPage.displayName = 'CheckoutPage';\nexport default CheckoutPage;","map":{"version":3,"sources":["D:/Amardeep/tarek_project/ftw-product/src/containers/CheckoutPage/CheckoutPage.js"],"names":["React","Component","bool","func","instanceOf","object","oneOfType","shape","string","compose","connect","withRouter","classNames","config","FormattedMessage","injectIntl","intlShape","routeConfiguration","pathByRouteName","findRouteByRouteName","propTypes","LINE_ITEM_NIGHT","LINE_ITEM_DAY","DATE_TYPE_DATE","ensureListing","ensureCurrentUser","ensureUser","ensureTransaction","ensureBooking","ensureStripeCustomer","ensurePaymentMethodCard","timeOfDayFromLocalToTimeZone","minutesBetween","createSlug","isTransactionInitiateAmountTooLowError","isTransactionInitiateListingNotFoundError","isTransactionInitiateMissingStripeAccountError","isTransactionInitiateBookingTimeNotAvailableError","isTransactionInitiateListingInsufficientStockError","isTransactionChargeDisabledError","isTransactionZeroPaymentError","isTransitionQuantityInfoMissingError","transactionInitiateOrderStripeErrors","formatMoney","TRANSITION_ENQUIRE","txIsPaymentPending","txIsPaymentExpired","txHasPassedPaymentPending","isScrollingDisabled","confirmCardPayment","retrievePaymentIntent","savePaymentMethod","AvatarMedium","AspectRatioWrapper","OrderBreakdown","Logo","NamedLink","NamedRedirect","Page","ResponsiveImage","initiateOrder","setInitialValues","speculateTransaction","stripeCustomer","confirmPayment","sendMessage","StripePaymentForm","storeData","storedData","clearData","css","STORAGE_KEY","STRIPE_PI_USER_ACTIONS_DONE_STATUSES","ONETIME_PAYMENT","PAY_AND_SAVE_FOR_LATER_USE","USE_SAVED_CARD","paymentFlow","selectedPaymentMethod","saveAfterOnetimePayment","initializeOrderPage","initialValues","routes","dispatch","OrderPage","checkIsPaymentExpired","existingTransaction","attributes","lastTransitionedAt","Date","getFormattedTotalPrice","transaction","intl","totalPrice","payinTotal","bookingDatesMaybe","bookingDates","apiTimeZone","bookingStart","bookingEnd","getErrorMessages","listingNotFound","initiateOrderError","speculateTransactionError","listingNotFoundErrorMessage","initiateOrderErrorMessage","speculateErrorMessage","isAmountTooLowError","isChargeDisabledError","stripeErrors","length","stripeErrorsAsString","join","listingLink","listingNotFoundErrorMessageParagraph","notFoundError","initiateOrderErrorMessageParagraph","orderError","speculateErrorMessageParagraph","speculateTransactionErrorMessageParagraph","speculateError","speculateTransactionErrorMessage","CheckoutPageComponent","constructor","props","state","pageData","dataLoaded","submitting","stripe","onStripeInitialized","bind","loadInitialData","handlePaymentIntent","handleSubmit","componentDidMount","window","orderData","listing","fetchSpeculatedTransaction","fetchStripeCustomer","history","hasNavigatedThroughLink","action","hasDataInProps","tx","shouldFetchSpeculatedTransaction","id","listingId","transactionId","quantity","quantityMaybe","deliveryMethod","setState","handlePaymentParams","currentUser","stripeCustomerFetched","onInitiateOrder","onConfirmCardPayment","onConfirmPayment","onSendMessage","onSavePaymentMethod","speculatedTransaction","message","paymentIntent","shippingDetails","storedTx","ensuredCurrentUser","ensuredStripeCustomer","ensuredDefaultPaymentMethod","defaultPaymentMethod","createdPaymentIntent","hasDefaultPaymentMethod","stripeCustomerId","stripePaymentMethodId","selectedPaymentFlow","fnRequestPayment","fnParams","hasPaymentIntents","protectedData","stripePaymentIntents","Promise","resolve","fnConfirmCardPayment","order","Error","stripePaymentIntentClientSecret","default","card","billingDetails","stripeElementMaybe","paymentParams","payment_method","billing_details","params","orderId","hasPaymentIntentUserActionsDone","includes","status","fnConfirmPayment","fnSendMessage","fnSavePaymentMethod","pi","then","response","errors","paymentMethodSaved","catch","e","applyAsync","acc","val","composeAsync","funcs","x","reduce","handlePaymentIntentCreation","protectedDataMaybe","optionalPaymentParams","paymentMethod","setupPaymentMethodForSaving","orderParams","values","formValues","name","addressLine1","addressLine2","postal","city","country","recipientName","recipientPhoneNumber","recipientAddressLine1","recipientAddressLine2","recipientPostal","recipientCity","recipientState","recipientCountry","addressMaybe","address","line1","line2","postal_code","email","shippingDetailsMaybe","phoneNumber","postalCode","requestPaymentParams","res","messageSuccess","initialMessageFailedToTransaction","orderDetailsPath","uuid","savePaymentMethodFailed","push","err","console","error","onRetrievePaymentIntent","shouldFetchPaymentIntent","render","scrollingDisabled","speculateTransactionInProgress","speculatedTransactionMaybe","confirmPaymentError","confirmCardPaymentError","retrievePaymentIntentError","isLoading","currentListing","currentAuthor","author","listingTitle","title","formatMessage","pageProps","topbar","home","logoMobile","logoDesktop","isOwnListing","hasRequiredData","canShowPage","shouldRedirect","booking","txBookingMaybe","dateType","breakdown","lineItems","orderBreakdown","lineItemUnitType","isPaymentExpired","showPaymentForm","firstImage","images","aspectWidth","aspectHeight","variantPrefix","variants","Object","keys","filter","k","startsWith","slug","unitType","isNightly","isDaily","unitTranslationKey","price","formattedPrice","detailsSubTitle","showInitialMessageInput","lastTransition","userName","profile","firstName","lastName","initalValuesForStripePayment","contentContainer","aspectWrapper","rootForImage","avatarWrapper","avatarMobile","bookListingContainer","heading","displayName","priceBreakdownContainer","paymentContainer","paymentForm","publicData","location","detailsContainerDesktop","detailsAspectWrapper","detailsHeadings","detailsTitle","detailsSubtitle","orderBreakdownTitle","defaultProps","isRequired","mapStateToProps","CheckoutPage","user","mapDispatchToProps","saveToSessionStorage"],"mappings":"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","sourcesContent":["import React, { Component } from 'react';\r\nimport { bool, func, instanceOf, object, oneOfType, shape, string } from 'prop-types';\r\nimport { compose } from 'redux';\r\nimport { connect } from 'react-redux';\r\nimport { withRouter } from 'react-router-dom';\r\nimport classNames from 'classnames';\r\n\r\n// Import configs and util modules\r\nimport config from '../../config';\r\nimport { FormattedMessage, injectIntl, intlShape } from '../../util/reactIntl';\r\nimport routeConfiguration from '../../routing/routeConfiguration';\r\nimport { pathByRouteName, findRouteByRouteName } from '../../util/routes';\r\nimport { propTypes, LINE_ITEM_NIGHT, LINE_ITEM_DAY, DATE_TYPE_DATE } from '../../util/types';\r\nimport {\r\n  ensureListing,\r\n  ensureCurrentUser,\r\n  ensureUser,\r\n  ensureTransaction,\r\n  ensureBooking,\r\n  ensureStripeCustomer,\r\n  ensurePaymentMethodCard,\r\n} from '../../util/data';\r\nimport { timeOfDayFromLocalToTimeZone, minutesBetween } from '../../util/dates';\r\nimport { createSlug } from '../../util/urlHelpers';\r\nimport {\r\n  isTransactionInitiateAmountTooLowError,\r\n  isTransactionInitiateListingNotFoundError,\r\n  isTransactionInitiateMissingStripeAccountError,\r\n  isTransactionInitiateBookingTimeNotAvailableError,\r\n  isTransactionInitiateListingInsufficientStockError,\r\n  isTransactionChargeDisabledError,\r\n  isTransactionZeroPaymentError,\r\n  isTransitionQuantityInfoMissingError,\r\n  transactionInitiateOrderStripeErrors,\r\n} from '../../util/errors';\r\nimport { formatMoney } from '../../util/currency';\r\nimport {\r\n  TRANSITION_ENQUIRE,\r\n  txIsPaymentPending,\r\n  txIsPaymentExpired,\r\n  txHasPassedPaymentPending,\r\n} from '../../util/transaction';\r\n\r\n// Import global thunk functions\r\nimport { isScrollingDisabled } from '../../ducks/UI.duck';\r\nimport { confirmCardPayment, retrievePaymentIntent } from '../../ducks/stripe.duck';\r\nimport { savePaymentMethod } from '../../ducks/paymentMethods.duck';\r\n\r\n// Import shared components\r\nimport {\r\n  AvatarMedium,\r\n  AspectRatioWrapper,\r\n  OrderBreakdown,\r\n  Logo,\r\n  NamedLink,\r\n  NamedRedirect,\r\n  Page,\r\n  ResponsiveImage,\r\n} from '../../components';\r\n\r\n// Import modules from this directory\r\nimport {\r\n  initiateOrder,\r\n  setInitialValues,\r\n  speculateTransaction,\r\n  stripeCustomer,\r\n  confirmPayment,\r\n  sendMessage,\r\n} from './CheckoutPage.duck';\r\nimport StripePaymentForm from './StripePaymentForm/StripePaymentForm';\r\nimport { storeData, storedData, clearData } from './CheckoutPageSessionHelpers';\r\nimport css from './CheckoutPage.module.css';\r\n\r\nconst STORAGE_KEY = 'CheckoutPage';\r\n\r\n// Stripe PaymentIntent statuses, where user actions are already completed\r\n// https://stripe.com/docs/payments/payment-intents/status\r\nconst STRIPE_PI_USER_ACTIONS_DONE_STATUSES = ['processing', 'requires_capture', 'succeeded'];\r\n\r\n// Payment charge options\r\nconst ONETIME_PAYMENT = 'ONETIME_PAYMENT';\r\nconst PAY_AND_SAVE_FOR_LATER_USE = 'PAY_AND_SAVE_FOR_LATER_USE';\r\nconst USE_SAVED_CARD = 'USE_SAVED_CARD';\r\n\r\nconst paymentFlow = (selectedPaymentMethod, saveAfterOnetimePayment) => {\r\n  // Payment mode could be 'replaceCard', but without explicit saveAfterOnetimePayment flag,\r\n  // we'll handle it as one-time payment\r\n  return selectedPaymentMethod === 'defaultCard'\r\n    ? USE_SAVED_CARD\r\n    : saveAfterOnetimePayment\r\n    ? PAY_AND_SAVE_FOR_LATER_USE\r\n    : ONETIME_PAYMENT;\r\n};\r\n\r\nconst initializeOrderPage = (initialValues, routes, dispatch) => {\r\n  const OrderPage = findRouteByRouteName('OrderDetailsPage', routes);\r\n\r\n  // Transaction is already created, but if the initial message\r\n  // sending failed, we tell it to the OrderDetailsPage.\r\n  dispatch(OrderPage.setInitialValues(initialValues));\r\n};\r\n\r\nconst checkIsPaymentExpired = existingTransaction => {\r\n  return txIsPaymentExpired(existingTransaction)\r\n    ? true\r\n    : txIsPaymentPending(existingTransaction)\r\n    ? minutesBetween(existingTransaction.attributes.lastTransitionedAt, new Date()) >= 15\r\n    : false;\r\n};\r\n\r\nconst getFormattedTotalPrice = (transaction, intl) => {\r\n  const totalPrice = transaction.attributes.payinTotal;\r\n  return formatMoney(intl, totalPrice);\r\n};\r\n\r\n// Convert the picked date to moment that will represent the same time of day in UTC time zone.\r\nconst bookingDatesMaybe = bookingDates => {\r\n  const apiTimeZone = 'Etc/UTC';\r\n  return bookingDates\r\n    ? {\r\n        bookingDates: {\r\n          bookingStart: timeOfDayFromLocalToTimeZone(bookingDates.bookingStart, apiTimeZone),\r\n          bookingEnd: timeOfDayFromLocalToTimeZone(bookingDates.bookingEnd, apiTimeZone),\r\n        },\r\n      }\r\n    : {};\r\n};\r\n\r\n// Collect error message checks to a single function.\r\nconst getErrorMessages = (listingNotFound, initiateOrderError, speculateTransactionError) => {\r\n  let listingNotFoundErrorMessage = null;\r\n  let initiateOrderErrorMessage = null;\r\n  let speculateErrorMessage = null;\r\n\r\n  const isAmountTooLowError = isTransactionInitiateAmountTooLowError(initiateOrderError);\r\n  const isChargeDisabledError = isTransactionChargeDisabledError(initiateOrderError);\r\n  const stripeErrors = transactionInitiateOrderStripeErrors(initiateOrderError);\r\n\r\n  // We want to show one error at a time for the real transition\r\n  if (listingNotFound) {\r\n    listingNotFoundErrorMessage = <FormattedMessage id=\"CheckoutPage.listingNotFoundError\" />;\r\n  } else if (isAmountTooLowError) {\r\n    initiateOrderErrorMessage = <FormattedMessage id=\"CheckoutPage.initiateOrderAmountTooLow\" />;\r\n  } else if (isTransactionInitiateBookingTimeNotAvailableError(initiateOrderError)) {\r\n    // If bookings are used, there could be error related to those\r\n    initiateOrderErrorMessage = (\r\n      <FormattedMessage id=\"CheckoutPage.bookingTimeNotAvailableMessage\" />\r\n    );\r\n  } else if (isTransitionQuantityInfoMissingError(initiateOrderError)) {\r\n    initiateOrderErrorMessage = (\r\n      <FormattedMessage id=\"CheckoutPage.correctQuantityInformationMissing\" />\r\n    );\r\n  } else if (isTransactionInitiateListingInsufficientStockError(initiateOrderError)) {\r\n    // If stock management is used, there could be error related to that\r\n    initiateOrderErrorMessage = <FormattedMessage id=\"CheckoutPage.notEnoughStockMessage\" />;\r\n  } else if (isChargeDisabledError) {\r\n    initiateOrderErrorMessage = <FormattedMessage id=\"CheckoutPage.chargeDisabledMessage\" />;\r\n  } else if (stripeErrors && stripeErrors.length > 0) {\r\n    // NOTE: Error messages from Stripes are not part of translations.\r\n    // By default they are in English.\r\n    const stripeErrorsAsString = stripeErrors.join(', ');\r\n    initiateOrderErrorMessage = (\r\n      <FormattedMessage\r\n        id=\"CheckoutPage.initiateOrderStripeError\"\r\n        values={{ stripeErrors: stripeErrorsAsString }}\r\n      />\r\n    );\r\n  } else if (initiateOrderError) {\r\n    // Generic initiate order error\r\n    initiateOrderErrorMessage = (\r\n      <FormattedMessage id=\"CheckoutPage.initiateOrderError\" values={{ listingLink }} />\r\n    );\r\n  }\r\n\r\n  // We want to show one error at a time for speculateTransition\r\n  if (isTransactionInitiateMissingStripeAccountError(speculateTransactionError)) {\r\n    speculateErrorMessage = (\r\n      <FormattedMessage id=\"CheckoutPage.providerStripeAccountMissingError\" />\r\n    );\r\n  } else if (isTransactionInitiateBookingTimeNotAvailableError(speculateTransactionError)) {\r\n    speculateErrorMessage = <FormattedMessage id=\"CheckoutPage.bookingTimeNotAvailableMessage\" />;\r\n  } else if (isTransactionInitiateListingInsufficientStockError(speculateTransactionError)) {\r\n    speculateErrorMessage = <FormattedMessage id=\"CheckoutPage.notEnoughStockMessage\" />;\r\n  } else if (isTransactionZeroPaymentError(speculateTransactionError)) {\r\n    speculateErrorMessage = <FormattedMessage id=\"CheckoutPage.initiateOrderAmountTooLow\" />;\r\n  } else if (isTransitionQuantityInfoMissingError(speculateTransactionError)) {\r\n    speculateErrorMessage = (\r\n      <FormattedMessage id=\"CheckoutPage.correctQuantityInformationMissing\" />\r\n    );\r\n  } else if (speculateTransactionError) {\r\n    speculateErrorMessage = <FormattedMessage id=\"CheckoutPage.speculateFailedMessage\" />;\r\n  }\r\n\r\n  // Add paragraph-container for the error message, if it exists\r\n  const listingNotFoundErrorMessageParagraph = listingNotFoundErrorMessage ? (\r\n    <p className={css.notFoundError}>{listingNotFoundErrorMessage}</p>\r\n  ) : null;\r\n  const initiateOrderErrorMessageParagraph = initiateOrderErrorMessage ? (\r\n    <p className={css.orderError}>{initiateOrderErrorMessage}</p>\r\n  ) : null;\r\n  const speculateErrorMessageParagraph = speculateErrorMessage ? (\r\n    <p className={css.orderError}>{speculateErrorMessage}</p>\r\n  ) : null;\r\n  const speculateTransactionErrorMessageParagraph = speculateTransactionError ? (\r\n    <p className={css.speculateError}>\r\n      <FormattedMessage id=\"CheckoutPage.speculateTransactionError\" />\r\n    </p>\r\n  ) : null;\r\n\r\n  return {\r\n    listingNotFoundErrorMessage: listingNotFoundErrorMessageParagraph,\r\n    initiateOrderErrorMessage: initiateOrderErrorMessageParagraph,\r\n    speculateErrorMessage: speculateErrorMessageParagraph,\r\n    speculateTransactionErrorMessage: speculateTransactionErrorMessageParagraph,\r\n  };\r\n};\r\n\r\nexport class CheckoutPageComponent extends Component {\r\n  constructor(props) {\r\n    super(props);\r\n\r\n    this.state = {\r\n      pageData: {},\r\n      dataLoaded: false,\r\n      submitting: false,\r\n    };\r\n    this.stripe = null;\r\n\r\n    this.onStripeInitialized = this.onStripeInitialized.bind(this);\r\n    this.loadInitialData = this.loadInitialData.bind(this);\r\n    this.handlePaymentIntent = this.handlePaymentIntent.bind(this);\r\n    this.handleSubmit = this.handleSubmit.bind(this);\r\n  }\r\n\r\n  componentDidMount() {\r\n    if (window) {\r\n      this.loadInitialData();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Load initial data for the page\r\n   *\r\n   * Since the data for the checkout is not passed in the URL (there\r\n   * might be lots of options in the future), we must pass in the data\r\n   * some other way. Currently the ListingPage sets the initial data\r\n   * for the CheckoutPage's Redux store.\r\n   *\r\n   * For some cases (e.g. a refresh in the CheckoutPage), the Redux\r\n   * store is empty. To handle that case, we store the received data\r\n   * to window.sessionStorage and read it from there if no props from\r\n   * the store exist.\r\n   *\r\n   * This function also sets of fetching the speculative transaction\r\n   * based on this initial data.\r\n   */\r\n  loadInitialData() {\r\n    const {\r\n      orderData,\r\n      listing,\r\n      transaction,\r\n      fetchSpeculatedTransaction,\r\n      fetchStripeCustomer,\r\n      history,\r\n    } = this.props;\r\n\r\n    // Fetch currentUser with stripeCustomer entity\r\n    // Note: since there's need for data loading in \"componentWillMount\" function,\r\n    //       this is added here instead of loadData static function.\r\n    fetchStripeCustomer();\r\n\r\n    // Browser's back navigation should not rewrite data in session store.\r\n    // Action is 'POP' on both history.back() and page refresh cases.\r\n    // Action is 'PUSH' when user has directed through a link\r\n    // Action is 'REPLACE' when user has directed through login/signup process\r\n    const hasNavigatedThroughLink = history.action === 'PUSH' || history.action === 'REPLACE';\r\n\r\n    const hasDataInProps = !!(orderData && listing && hasNavigatedThroughLink);\r\n    if (hasDataInProps) {\r\n      // Store data only if data is passed through props and user has navigated through a link.\r\n      storeData(orderData, listing, transaction, STORAGE_KEY);\r\n    }\r\n\r\n    // NOTE: stored data can be empty if user has already successfully completed transaction.\r\n    const pageData = hasDataInProps ? { orderData, listing, transaction } : storedData(STORAGE_KEY);\r\n\r\n    const tx = pageData ? pageData.transaction : null;\r\n\r\n    // If transaction has passed payment-pending state, speculated tx is not needed.\r\n    const shouldFetchSpeculatedTransaction =\r\n      pageData &&\r\n      pageData.listing &&\r\n      pageData.listing.id &&\r\n      pageData.orderData &&\r\n      !txHasPassedPaymentPending(tx);\r\n\r\n    if (shouldFetchSpeculatedTransaction) {\r\n      const listingId = pageData.listing.id;\r\n      const transactionId = tx ? tx.id : null;\r\n\r\n      // Fetch speculated transaction for showing price in order breakdown\r\n      // NOTE: if unit type is line-item/units, quantity needs to be added.\r\n      // The way to pass it to checkout page is through pageData.orderData\r\n      const quantity = pageData.orderData?.quantity;\r\n      const quantityMaybe = quantity ? { quantity } : {};\r\n      const deliveryMethod = pageData.orderData?.deliveryMethod;\r\n      fetchSpeculatedTransaction(\r\n        {\r\n          listingId,\r\n          deliveryMethod,\r\n          ...quantityMaybe,\r\n          ...bookingDatesMaybe(pageData.orderData.bookingDates),\r\n        },\r\n        transactionId\r\n      );\r\n    }\r\n\r\n    this.setState({ pageData: pageData || {}, dataLoaded: true });\r\n  }\r\n\r\n  handlePaymentIntent(handlePaymentParams) {\r\n    const {\r\n      currentUser,\r\n      stripeCustomerFetched,\r\n      onInitiateOrder,\r\n      onConfirmCardPayment,\r\n      onConfirmPayment,\r\n      onSendMessage,\r\n      onSavePaymentMethod,\r\n    } = this.props;\r\n    const {\r\n      pageData,\r\n      speculatedTransaction,\r\n      message,\r\n      paymentIntent,\r\n      selectedPaymentMethod,\r\n      saveAfterOnetimePayment,\r\n      shippingDetails,\r\n    } = handlePaymentParams;\r\n    const storedTx = ensureTransaction(pageData.transaction);\r\n\r\n    const ensuredCurrentUser = ensureCurrentUser(currentUser);\r\n    const ensuredStripeCustomer = ensureStripeCustomer(ensuredCurrentUser.stripeCustomer);\r\n    const ensuredDefaultPaymentMethod = ensurePaymentMethodCard(\r\n      ensuredStripeCustomer.defaultPaymentMethod\r\n    );\r\n\r\n    let createdPaymentIntent = null;\r\n\r\n    const hasDefaultPaymentMethod = !!(\r\n      stripeCustomerFetched &&\r\n      ensuredStripeCustomer.attributes.stripeCustomerId &&\r\n      ensuredDefaultPaymentMethod.id\r\n    );\r\n    const stripePaymentMethodId = hasDefaultPaymentMethod\r\n      ? ensuredDefaultPaymentMethod.attributes.stripePaymentMethodId\r\n      : null;\r\n\r\n    const selectedPaymentFlow = paymentFlow(selectedPaymentMethod, saveAfterOnetimePayment);\r\n\r\n    // Step 1: initiate order by requesting payment from Marketplace API\r\n    const fnRequestPayment = fnParams => {\r\n      // fnParams should be { listingId, deliveryMethod, quantity?, bookingDates?, paymentMethod?/setupPaymentMethodForSaving? }\r\n      const hasPaymentIntents =\r\n        storedTx.attributes.protectedData && storedTx.attributes.protectedData.stripePaymentIntents;\r\n\r\n      // If paymentIntent exists, order has been initiated previously.\r\n      return hasPaymentIntents ? Promise.resolve(storedTx) : onInitiateOrder(fnParams, storedTx.id);\r\n    };\r\n\r\n    // Step 2: pay using Stripe SDK\r\n    const fnConfirmCardPayment = fnParams => {\r\n      // fnParams should be returned transaction entity\r\n\r\n      const order = ensureTransaction(fnParams);\r\n      if (order.id) {\r\n        // Store order.\r\n        const { orderData, listing } = pageData;\r\n        storeData(orderData, listing, order, STORAGE_KEY);\r\n        this.setState({ pageData: { ...pageData, transaction: order } });\r\n      }\r\n\r\n      const hasPaymentIntents =\r\n        order.attributes.protectedData && order.attributes.protectedData.stripePaymentIntents;\r\n\r\n      if (!hasPaymentIntents) {\r\n        throw new Error(\r\n          `Missing StripePaymentIntents key in transaction's protectedData. Check that your transaction process is configured to use payment intents.`\r\n        );\r\n      }\r\n\r\n      const { stripePaymentIntentClientSecret } = hasPaymentIntents\r\n        ? order.attributes.protectedData.stripePaymentIntents.default\r\n        : null;\r\n\r\n      const { stripe, card, billingDetails, paymentIntent } = handlePaymentParams;\r\n      const stripeElementMaybe = selectedPaymentFlow !== USE_SAVED_CARD ? { card } : {};\r\n\r\n      // Note: For basic USE_SAVED_CARD scenario, we have set it already on API side, when PaymentIntent was created.\r\n      // However, the payment_method is save here for USE_SAVED_CARD flow if customer first attempted onetime payment\r\n      const paymentParams =\r\n        selectedPaymentFlow !== USE_SAVED_CARD\r\n          ? {\r\n              payment_method: {\r\n                billing_details: billingDetails,\r\n                card: card,\r\n              },\r\n            }\r\n          : { payment_method: stripePaymentMethodId };\r\n\r\n      const params = {\r\n        stripePaymentIntentClientSecret,\r\n        orderId: order.id,\r\n        stripe,\r\n        ...stripeElementMaybe,\r\n        paymentParams,\r\n      };\r\n\r\n      // If paymentIntent status is not waiting user action,\r\n      // confirmCardPayment has been called previously.\r\n      const hasPaymentIntentUserActionsDone =\r\n        paymentIntent && STRIPE_PI_USER_ACTIONS_DONE_STATUSES.includes(paymentIntent.status);\r\n      return hasPaymentIntentUserActionsDone\r\n        ? Promise.resolve({ transactionId: order.id, paymentIntent })\r\n        : onConfirmCardPayment(params);\r\n    };\r\n\r\n    // Step 3: complete order by confirming payment to Marketplace API\r\n    // Parameter should contain { paymentIntent, transactionId } returned in step 2\r\n    const fnConfirmPayment = fnParams => {\r\n      createdPaymentIntent = fnParams.paymentIntent;\r\n      return onConfirmPayment(fnParams);\r\n    };\r\n\r\n    // Step 4: send initial message\r\n    const fnSendMessage = fnParams => {\r\n      return onSendMessage({ ...fnParams, message });\r\n    };\r\n\r\n    // Step 5: optionally save card as defaultPaymentMethod\r\n    const fnSavePaymentMethod = fnParams => {\r\n      const pi = createdPaymentIntent || paymentIntent;\r\n\r\n      if (selectedPaymentFlow === PAY_AND_SAVE_FOR_LATER_USE) {\r\n        return onSavePaymentMethod(ensuredStripeCustomer, pi.payment_method)\r\n          .then(response => {\r\n            if (response.errors) {\r\n              return { ...fnParams, paymentMethodSaved: false };\r\n            }\r\n            return { ...fnParams, paymentMethodSaved: true };\r\n          })\r\n          .catch(e => {\r\n            // Real error cases are catched already in paymentMethods page.\r\n            return { ...fnParams, paymentMethodSaved: false };\r\n          });\r\n      } else {\r\n        return Promise.resolve({ ...fnParams, paymentMethodSaved: true });\r\n      }\r\n    };\r\n\r\n    // Here we create promise calls in sequence\r\n    // This is pretty much the same as:\r\n    // fnRequestPayment({...initialParams})\r\n    //   .then(result => fnConfirmCardPayment({...result}))\r\n    //   .then(result => fnConfirmPayment({...result}))\r\n    const applyAsync = (acc, val) => acc.then(val);\r\n    const composeAsync = (...funcs) => x => funcs.reduce(applyAsync, Promise.resolve(x));\r\n    const handlePaymentIntentCreation = composeAsync(\r\n      fnRequestPayment,\r\n      fnConfirmCardPayment,\r\n      fnConfirmPayment,\r\n      fnSendMessage,\r\n      fnSavePaymentMethod\r\n    );\r\n\r\n    // Create order aka transaction\r\n    // NOTE: if unit type is line-item/units, quantity needs to be added.\r\n    // The way to pass it to checkout page is through pageData.orderData\r\n    const tx = speculatedTransaction ? speculatedTransaction : storedTx;\r\n\r\n    const deliveryMethod = pageData.orderData?.deliveryMethod;\r\n    const quantity = pageData.orderData?.quantity;\r\n    const quantityMaybe = quantity ? { quantity } : {};\r\n    const protectedDataMaybe =\r\n      deliveryMethod && shippingDetails\r\n        ? { protectedData: { deliveryMethod, shippingDetails } }\r\n        : deliveryMethod\r\n        ? { protectedData: { deliveryMethod } }\r\n        : {};\r\n    // Note: optionalPaymentParams contains Stripe paymentMethod,\r\n    // but that can also be passed on Step 2\r\n    // stripe.confirmCardPayment(stripe, { payment_method: stripePaymentMethodId })\r\n    const optionalPaymentParams =\r\n      selectedPaymentFlow === USE_SAVED_CARD && hasDefaultPaymentMethod\r\n        ? { paymentMethod: stripePaymentMethodId }\r\n        : selectedPaymentFlow === PAY_AND_SAVE_FOR_LATER_USE\r\n        ? { setupPaymentMethodForSaving: true }\r\n        : {};\r\n\r\n    const orderParams = {\r\n      listingId: pageData.listing.id,\r\n      deliveryMethod,\r\n      ...quantityMaybe,\r\n      ...bookingDatesMaybe(pageData.orderData.bookingDates),\r\n      ...protectedDataMaybe,\r\n      ...optionalPaymentParams,\r\n    };\r\n\r\n    return handlePaymentIntentCreation(orderParams);\r\n  }\r\n\r\n  handleSubmit(values) {\r\n    if (this.state.submitting) {\r\n      return;\r\n    }\r\n    this.setState({ submitting: true });\r\n\r\n    const { history, speculatedTransaction, currentUser, paymentIntent, dispatch } = this.props;\r\n    const { card, message, paymentMethod, formValues } = values;\r\n    const {\r\n      name,\r\n      addressLine1,\r\n      addressLine2,\r\n      postal,\r\n      city,\r\n      state,\r\n      country,\r\n      saveAfterOnetimePayment,\r\n      recipientName,\r\n      recipientPhoneNumber,\r\n      recipientAddressLine1,\r\n      recipientAddressLine2,\r\n      recipientPostal,\r\n      recipientCity,\r\n      recipientState,\r\n      recipientCountry,\r\n    } = formValues;\r\n\r\n    // Billing address is recommended.\r\n    // However, let's not assume that <StripePaymentAddress> data is among formValues.\r\n    // Read more about this from Stripe's docs\r\n    // https://stripe.com/docs/stripe-js/reference#stripe-handle-card-payment-no-element\r\n    const addressMaybe =\r\n      addressLine1 && postal\r\n        ? {\r\n            address: {\r\n              city: city,\r\n              country: country,\r\n              line1: addressLine1,\r\n              line2: addressLine2,\r\n              postal_code: postal,\r\n              state: state,\r\n            },\r\n          }\r\n        : {};\r\n    const billingDetails = {\r\n      name,\r\n      email: ensureCurrentUser(currentUser).attributes.email,\r\n      ...addressMaybe,\r\n    };\r\n\r\n    const shippingDetailsMaybe =\r\n      recipientName && recipientAddressLine1 && recipientPostal\r\n        ? {\r\n            shippingDetails: {\r\n              name: recipientName,\r\n              phoneNumber: recipientPhoneNumber,\r\n              address: {\r\n                city: recipientCity,\r\n                country: recipientCountry,\r\n                line1: recipientAddressLine1,\r\n                line2: recipientAddressLine2,\r\n                postalCode: recipientPostal,\r\n                state: recipientState,\r\n              },\r\n            },\r\n          }\r\n        : {};\r\n    const requestPaymentParams = {\r\n      pageData: this.state.pageData,\r\n      speculatedTransaction,\r\n      stripe: this.stripe,\r\n      card,\r\n      billingDetails,\r\n      message,\r\n      paymentIntent,\r\n      selectedPaymentMethod: paymentMethod,\r\n      saveAfterOnetimePayment: !!saveAfterOnetimePayment,\r\n      ...shippingDetailsMaybe,\r\n    };\r\n\r\n    this.handlePaymentIntent(requestPaymentParams)\r\n      .then(res => {\r\n        const { orderId, messageSuccess, paymentMethodSaved } = res;\r\n        this.setState({ submitting: false });\r\n\r\n        const routes = routeConfiguration();\r\n        const initialMessageFailedToTransaction = messageSuccess ? null : orderId;\r\n        const orderDetailsPath = pathByRouteName('OrderDetailsPage', routes, { id: orderId.uuid });\r\n        const initialValues = {\r\n          initialMessageFailedToTransaction,\r\n          savePaymentMethodFailed: !paymentMethodSaved,\r\n        };\r\n\r\n        initializeOrderPage(initialValues, routes, dispatch);\r\n        clearData(STORAGE_KEY);\r\n        history.push(orderDetailsPath);\r\n      })\r\n      .catch(err => {\r\n        console.error(err);\r\n        this.setState({ submitting: false });\r\n      });\r\n  }\r\n\r\n  onStripeInitialized(stripe) {\r\n    this.stripe = stripe;\r\n\r\n    const { paymentIntent, onRetrievePaymentIntent } = this.props;\r\n    const tx = this.state.pageData ? this.state.pageData.transaction : null;\r\n\r\n    // We need to get up to date PI, if payment is pending but it's not expired.\r\n    const shouldFetchPaymentIntent =\r\n      this.stripe &&\r\n      !paymentIntent &&\r\n      tx &&\r\n      tx.id &&\r\n      txIsPaymentPending(tx) &&\r\n      !checkIsPaymentExpired(tx);\r\n\r\n    if (shouldFetchPaymentIntent) {\r\n      const { stripePaymentIntentClientSecret } =\r\n        tx.attributes.protectedData && tx.attributes.protectedData.stripePaymentIntents\r\n          ? tx.attributes.protectedData.stripePaymentIntents.default\r\n          : {};\r\n\r\n      // Fetch up to date PaymentIntent from Stripe\r\n      onRetrievePaymentIntent({ stripe, stripePaymentIntentClientSecret });\r\n    }\r\n  }\r\n\r\n  render() {\r\n    const {\r\n      scrollingDisabled,\r\n      speculateTransactionInProgress,\r\n      speculateTransactionError,\r\n      speculatedTransaction: speculatedTransactionMaybe,\r\n      initiateOrderError,\r\n      confirmPaymentError,\r\n      intl,\r\n      params,\r\n      currentUser,\r\n      confirmCardPaymentError,\r\n      paymentIntent,\r\n      retrievePaymentIntentError,\r\n      stripeCustomerFetched,\r\n    } = this.props;\r\n\r\n    // Since the listing data is already given from the ListingPage\r\n    // and stored to handle refreshes, it might not have the possible\r\n    // deleted or closed information in it. If the transaction\r\n    // initiate or the speculative initiate fail due to the listing\r\n    // being deleted or closec, we should dig the information from the\r\n    // errors and not the listing data.\r\n    const listingNotFound =\r\n      isTransactionInitiateListingNotFoundError(speculateTransactionError) ||\r\n      isTransactionInitiateListingNotFoundError(initiateOrderError);\r\n\r\n    const {\r\n      listingNotFoundErrorMessage,\r\n      initiateOrderErrorMessage,\r\n      speculateErrorMessage,\r\n      speculateTransactionErrorMessage,\r\n    } = getErrorMessages(listingNotFound, initiateOrderError, speculateTransactionError);\r\n\r\n    const isLoading = !this.state.dataLoaded || speculateTransactionInProgress;\r\n\r\n    const { listing, transaction, orderData } = this.state.pageData;\r\n    const existingTransaction = ensureTransaction(transaction);\r\n    const speculatedTransaction = ensureTransaction(speculatedTransactionMaybe, {}, null);\r\n    const currentListing = ensureListing(listing);\r\n    const currentAuthor = ensureUser(currentListing.author);\r\n\r\n    const listingTitle = currentListing.attributes.title;\r\n    const title = intl.formatMessage({ id: 'CheckoutPage.title' }, { listingTitle });\r\n\r\n    const pageProps = { title, scrollingDisabled };\r\n    const topbar = (\r\n      <div className={css.topbar}>\r\n        <NamedLink className={css.home} name=\"LandingPage\">\r\n          <Logo\r\n            className={css.logoMobile}\r\n            title={intl.formatMessage({ id: 'CheckoutPage.goToLandingPage' })}\r\n            format=\"mobile\"\r\n          />\r\n          <Logo\r\n            className={css.logoDesktop}\r\n            alt={intl.formatMessage({ id: 'CheckoutPage.goToLandingPage' })}\r\n            format=\"desktop\"\r\n          />\r\n        </NamedLink>\r\n      </div>\r\n    );\r\n\r\n    if (isLoading) {\r\n      return <Page {...pageProps}>{topbar}</Page>;\r\n    }\r\n\r\n    const isOwnListing =\r\n      currentUser &&\r\n      currentUser.id &&\r\n      currentAuthor &&\r\n      currentAuthor.id &&\r\n      currentAuthor.id.uuid === currentUser.id.uuid;\r\n\r\n    const hasRequiredData = !!(currentListing.id && currentAuthor.id);\r\n    const canShowPage = hasRequiredData && !isOwnListing;\r\n    const shouldRedirect = !isLoading && !canShowPage;\r\n\r\n    // Redirect back to ListingPage if data is missing.\r\n    // Redirection must happen before any data format error is thrown (e.g. wrong currency)\r\n    if (shouldRedirect) {\r\n      // eslint-disable-next-line no-console\r\n      console.error('Missing or invalid data for checkout, redirecting back to listing page.', {\r\n        transaction: speculatedTransaction,\r\n        listing,\r\n      });\r\n      return <NamedRedirect name=\"ListingPage\" params={params} />;\r\n    }\r\n\r\n    // Show breakdown only when (speculated?) transaction is loaded\r\n    // (i.e. have an id and lineItems)\r\n    const tx = existingTransaction.booking ? existingTransaction : speculatedTransaction;\r\n    const txBookingMaybe = tx.booking?.id\r\n      ? { booking: ensureBooking(tx.booking), dateType: DATE_TYPE_DATE }\r\n      : {};\r\n    const breakdown =\r\n      tx.id && tx.attributes.lineItems?.length > 0 ? (\r\n        <OrderBreakdown\r\n          className={css.orderBreakdown}\r\n          userRole=\"customer\"\r\n          unitType={config.lineItemUnitType}\r\n          transaction={tx}\r\n          {...txBookingMaybe}\r\n        />\r\n      ) : null;\r\n\r\n    const isPaymentExpired = checkIsPaymentExpired(existingTransaction);\r\n    const hasDefaultPaymentMethod = !!(\r\n      stripeCustomerFetched &&\r\n      ensureStripeCustomer(currentUser.stripeCustomer).attributes.stripeCustomerId &&\r\n      ensurePaymentMethodCard(currentUser.stripeCustomer.defaultPaymentMethod).id\r\n    );\r\n\r\n    // Allow showing page when currentUser is still being downloaded,\r\n    // but show payment form only when user info is loaded.\r\n    const showPaymentForm = !!(\r\n      currentUser &&\r\n      hasRequiredData &&\r\n      !listingNotFound &&\r\n      !initiateOrderError &&\r\n      !speculateTransactionError &&\r\n      !retrievePaymentIntentError &&\r\n      !isPaymentExpired\r\n    );\r\n\r\n    const firstImage =\r\n      currentListing.images && currentListing.images.length > 0 ? currentListing.images[0] : null;\r\n\r\n    const { aspectWidth = 1, aspectHeight = 1, variantPrefix = 'listing-card' } = config.listing;\r\n    const variants = firstImage\r\n      ? Object.keys(firstImage?.attributes?.variants).filter(k => k.startsWith(variantPrefix))\r\n      : [];\r\n\r\n    const listingLink = (\r\n      <NamedLink\r\n        name=\"ListingPage\"\r\n        params={{ id: currentListing.id.uuid, slug: createSlug(listingTitle) }}\r\n      >\r\n        <FormattedMessage id=\"CheckoutPage.errorlistingLinkText\" />\r\n      </NamedLink>\r\n    );\r\n\r\n    const unitType = config.lineItemUnitType;\r\n    const isNightly = unitType === LINE_ITEM_NIGHT;\r\n    const isDaily = unitType === LINE_ITEM_DAY;\r\n\r\n    const unitTranslationKey = isNightly\r\n      ? 'CheckoutPage.perNight'\r\n      : isDaily\r\n      ? 'CheckoutPage.perDay'\r\n      : 'CheckoutPage.perUnit';\r\n\r\n    const price = currentListing.attributes.price;\r\n    const formattedPrice = formatMoney(intl, price);\r\n    const detailsSubTitle = `${formattedPrice} ${intl.formatMessage({ id: unitTranslationKey })}`;\r\n\r\n    const showInitialMessageInput = !(\r\n      existingTransaction && existingTransaction.attributes.lastTransition === TRANSITION_ENQUIRE\r\n    );\r\n\r\n    // Get first and last name of the current user and use it in the StripePaymentForm to autofill the name field\r\n    const userName =\r\n      currentUser && currentUser.attributes\r\n        ? `${currentUser.attributes.profile.firstName} ${currentUser.attributes.profile.lastName}`\r\n        : null;\r\n\r\n    // If paymentIntent status is not waiting user action,\r\n    // confirmCardPayment has been called previously.\r\n    const hasPaymentIntentUserActionsDone =\r\n      paymentIntent && STRIPE_PI_USER_ACTIONS_DONE_STATUSES.includes(paymentIntent.status);\r\n\r\n    // If your marketplace works mostly in one country you can use initial values to select country automatically\r\n    // e.g. {country: 'FI'}\r\n\r\n    const initalValuesForStripePayment = { name: userName, recipientName: userName };\r\n\r\n    return (\r\n      <Page {...pageProps}>\r\n        {topbar}\r\n        <div className={css.contentContainer}>\r\n          <AspectRatioWrapper\r\n            width={aspectWidth}\r\n            height={aspectHeight}\r\n            className={css.aspectWrapper}\r\n          >\r\n            <ResponsiveImage\r\n              rootClassName={css.rootForImage}\r\n              alt={listingTitle}\r\n              image={firstImage}\r\n              variants={variants}\r\n            />\r\n          </AspectRatioWrapper>\r\n          <div className={classNames(css.avatarWrapper, css.avatarMobile)}>\r\n            <AvatarMedium user={currentAuthor} disableProfileLink />\r\n          </div>\r\n          <div className={css.bookListingContainer}>\r\n            <div className={css.heading}>\r\n              <h1 className={css.title}>{title}</h1>\r\n              <div className={css.author}>\r\n                <FormattedMessage\r\n                  id=\"CheckoutPage.providerInfo\"\r\n                  values={{ name: currentAuthor.attributes.profile.displayName }}\r\n                />\r\n              </div>\r\n            </div>\r\n\r\n            <div className={css.priceBreakdownContainer}>\r\n              {speculateTransactionErrorMessage}\r\n              {breakdown}\r\n            </div>\r\n\r\n            <section className={css.paymentContainer}>\r\n              {initiateOrderErrorMessage}\r\n              {listingNotFoundErrorMessage}\r\n              {speculateErrorMessage}\r\n              {retrievePaymentIntentError ? (\r\n                <p className={css.orderError}>\r\n                  <FormattedMessage\r\n                    id=\"CheckoutPage.retrievingStripePaymentIntentFailed\"\r\n                    values={{ listingLink }}\r\n                  />\r\n                </p>\r\n              ) : null}\r\n              {showPaymentForm ? (\r\n                <StripePaymentForm\r\n                  className={css.paymentForm}\r\n                  onSubmit={this.handleSubmit}\r\n                  inProgress={this.state.submitting}\r\n                  formId=\"CheckoutPagePaymentForm\"\r\n                  authorDisplayName={currentAuthor.attributes.profile.displayName}\r\n                  showInitialMessageInput={showInitialMessageInput}\r\n                  initialValues={initalValuesForStripePayment}\r\n                  initiateOrderError={initiateOrderError}\r\n                  confirmCardPaymentError={confirmCardPaymentError}\r\n                  confirmPaymentError={confirmPaymentError}\r\n                  hasHandledCardPayment={hasPaymentIntentUserActionsDone}\r\n                  loadingData={!stripeCustomerFetched}\r\n                  defaultPaymentMethod={\r\n                    hasDefaultPaymentMethod ? currentUser.stripeCustomer.defaultPaymentMethod : null\r\n                  }\r\n                  paymentIntent={paymentIntent}\r\n                  onStripeInitialized={this.onStripeInitialized}\r\n                  askShippingDetails={orderData?.deliveryMethod === 'shipping'}\r\n                  pickupLocation={currentListing?.attributes?.publicData?.location}\r\n                  totalPrice={tx.id ? getFormattedTotalPrice(tx, intl) : null}\r\n                />\r\n              ) : null}\r\n              {isPaymentExpired ? (\r\n                <p className={css.orderError}>\r\n                  <FormattedMessage\r\n                    id=\"CheckoutPage.paymentExpiredMessage\"\r\n                    values={{ listingLink }}\r\n                  />\r\n                </p>\r\n              ) : null}\r\n            </section>\r\n          </div>\r\n\r\n          <div className={css.detailsContainerDesktop}>\r\n            <AspectRatioWrapper\r\n              width={aspectWidth}\r\n              height={aspectHeight}\r\n              className={css.detailsAspectWrapper}\r\n            >\r\n              <ResponsiveImage\r\n                rootClassName={css.rootForImage}\r\n                alt={listingTitle}\r\n                image={firstImage}\r\n                variants={variants}\r\n              />\r\n            </AspectRatioWrapper>\r\n            <div className={css.avatarWrapper}>\r\n              <AvatarMedium user={currentAuthor} disableProfileLink />\r\n            </div>\r\n            <div className={css.detailsHeadings}>\r\n              <h2 className={css.detailsTitle}>{listingTitle}</h2>\r\n              <p className={css.detailsSubtitle}>{detailsSubTitle}</p>\r\n            </div>\r\n            {speculateTransactionErrorMessage}\r\n            <h2 className={css.orderBreakdownTitle}>\r\n              <FormattedMessage id=\"CheckoutPage.orderBreakdown\" />\r\n            </h2>\r\n            {breakdown}\r\n          </div>\r\n        </div>\r\n      </Page>\r\n    );\r\n  }\r\n}\r\n\r\nCheckoutPageComponent.defaultProps = {\r\n  initiateOrderError: null,\r\n  confirmPaymentError: null,\r\n  listing: null,\r\n  orderData: {},\r\n  speculateTransactionError: null,\r\n  speculatedTransaction: null,\r\n  transaction: null,\r\n  currentUser: null,\r\n  paymentIntent: null,\r\n};\r\n\r\nCheckoutPageComponent.propTypes = {\r\n  scrollingDisabled: bool.isRequired,\r\n  listing: propTypes.listing,\r\n  orderData: object,\r\n  fetchStripeCustomer: func.isRequired,\r\n  stripeCustomerFetched: bool.isRequired,\r\n  fetchSpeculatedTransaction: func.isRequired,\r\n  speculateTransactionInProgress: bool.isRequired,\r\n  speculateTransactionError: propTypes.error,\r\n  speculatedTransaction: propTypes.transaction,\r\n  transaction: propTypes.transaction,\r\n  currentUser: propTypes.currentUser,\r\n  params: shape({\r\n    id: string,\r\n    slug: string,\r\n  }).isRequired,\r\n  onConfirmPayment: func.isRequired,\r\n  onInitiateOrder: func.isRequired,\r\n  onConfirmCardPayment: func.isRequired,\r\n  onRetrievePaymentIntent: func.isRequired,\r\n  onSavePaymentMethod: func.isRequired,\r\n  onSendMessage: func.isRequired,\r\n  initiateOrderError: propTypes.error,\r\n  confirmPaymentError: propTypes.error,\r\n  // confirmCardPaymentError comes from Stripe so that's why we can't expect it to be in a specific form\r\n  confirmCardPaymentError: oneOfType([propTypes.error, object]),\r\n  paymentIntent: object,\r\n\r\n  // from connect\r\n  dispatch: func.isRequired,\r\n\r\n  // from injectIntl\r\n  intl: intlShape.isRequired,\r\n\r\n  // from withRouter\r\n  history: shape({\r\n    push: func.isRequired,\r\n  }).isRequired,\r\n};\r\n\r\nconst mapStateToProps = state => {\r\n  const {\r\n    listing,\r\n    orderData,\r\n    stripeCustomerFetched,\r\n    speculateTransactionInProgress,\r\n    speculateTransactionError,\r\n    speculatedTransaction,\r\n    transaction,\r\n    initiateOrderError,\r\n    confirmPaymentError,\r\n  } = state.CheckoutPage;\r\n  const { currentUser } = state.user;\r\n  const { confirmCardPaymentError, paymentIntent, retrievePaymentIntentError } = state.stripe;\r\n  return {\r\n    scrollingDisabled: isScrollingDisabled(state),\r\n    currentUser,\r\n    stripeCustomerFetched,\r\n    orderData,\r\n    speculateTransactionInProgress,\r\n    speculateTransactionError,\r\n    speculatedTransaction,\r\n    transaction,\r\n    listing,\r\n    initiateOrderError,\r\n    confirmCardPaymentError,\r\n    confirmPaymentError,\r\n    paymentIntent,\r\n    retrievePaymentIntentError,\r\n  };\r\n};\r\n\r\nconst mapDispatchToProps = dispatch => ({\r\n  dispatch,\r\n  fetchSpeculatedTransaction: (params, transactionId) =>\r\n    dispatch(speculateTransaction(params, transactionId)),\r\n  fetchStripeCustomer: () => dispatch(stripeCustomer()),\r\n  onInitiateOrder: (params, transactionId) => dispatch(initiateOrder(params, transactionId)),\r\n  onRetrievePaymentIntent: params => dispatch(retrievePaymentIntent(params)),\r\n  onConfirmCardPayment: params => dispatch(confirmCardPayment(params)),\r\n  onConfirmPayment: params => dispatch(confirmPayment(params)),\r\n  onSendMessage: params => dispatch(sendMessage(params)),\r\n  onSavePaymentMethod: (stripeCustomer, stripePaymentMethodId) =>\r\n    dispatch(savePaymentMethod(stripeCustomer, stripePaymentMethodId)),\r\n});\r\n\r\nconst CheckoutPage = compose(\r\n  withRouter,\r\n  connect(\r\n    mapStateToProps,\r\n    mapDispatchToProps\r\n  ),\r\n  injectIntl\r\n)(CheckoutPageComponent);\r\n\r\nCheckoutPage.setInitialValues = (initialValues, saveToSessionStorage = false) => {\r\n  if (saveToSessionStorage) {\r\n    const { listing, orderData } = initialValues;\r\n    storeData(orderData, listing, null, STORAGE_KEY);\r\n  }\r\n\r\n  return setInitialValues(initialValues);\r\n};\r\n\r\nCheckoutPage.displayName = 'CheckoutPage';\r\n\r\nexport default CheckoutPage;\r\n"]},"metadata":{},"sourceType":"module"}